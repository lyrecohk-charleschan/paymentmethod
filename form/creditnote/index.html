<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Credit Note Request Form</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">
  <div class="bg-white p-8 rounded-lg shadow-lg w-full max-w-4xl">
    <img src="https://cdn-s1.lyreco.com/staticswebshop/pictures/looknfeel/common/logo.svg" alt="Lyreco Logo" class="h-12 mb-6">
    <h1 class="text-2xl font-bold mb-6 text-center">Credit Note Request Form</h1>
    <form id="creditNoteForm" class="space-y-6">
      <!-- Company Details -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-medium text-gray-700">Company Name <span class="text-red-500">*</span></label>
          <input type="text" id="companyName" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" required>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700">Account No. <span class="text-red-500">*</span></label>
          <input type="text" id="accountNo" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" required>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700">Contact Person <span class="text-red-500">*</span></label>
          <input type="text" id="contactPerson" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" required>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700">Telephone <span class="text-red-500">*</span></label>
          <input type="tel" id="telephone" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" required>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700">Fax</label>
          <input type="text" id="fax" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700">Sales Rep. / Code <span class="text-red-500">*</span></label>
          <input type="text" id="salesRep" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" required>
        </div>
      </div>

      <!-- Invoice Details -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-medium text-gray-700">Invoice No. <span class="text-red-500">*</span></label>
          <input type="text" id="invoiceNo" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" required>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700">Invoice Date <span class="text-red-500">*</span></label>
          <input type="date" id="invoiceDate" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" required>
        </div>
      </div>

      <!-- Reason and Follow-up (Parallel) -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-medium text-gray-700">Reason for Credit Adjustment</label>
          <textarea id="reason" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" rows="4"></textarea>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700">Follow-up Action by CSO</label>
          <textarea id="followUp" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" rows="4"></textarea>
        </div>
      </div>

      <!-- Items Table -->
      <div>
        <h2 class="text-lg font-medium text-gray-700 mb-2">Items</h2>
        <div class="overflow-x-auto">
          <table class="min-w-full border-collapse">
            <thead>
              <tr class="bg-gray-200">
                <th class="px-4 py-2 text-left text-sm font-medium text-gray-700">SAP Code</th>
                <th class="px-4 py-2 text-left text-sm font-medium text-gray-700">Invoice Price</th>
                <th class="px-4 py-2 text-left text-sm font-medium text-gray-700">Offered Price</th>
                <th class="px-4 py-2 text-left text-sm font-medium text-gray-700">Adjusting Amount</th>
                <th class="px-4 py-2 text-left text-sm font-medium text-gray-700">Quantity</th>
                <th class="px-4 py-2 text-left text-sm font-medium text-gray-700">Amount</th>
                <th class="px-4 py-2"></th>
              </tr>
            </thead>
            <tbody id="itemsTable">
              <tr class="item-row">
                <td class="px-4 py-2"><input type="text" class="w-full rounded-md border-gray-300 shadow-sm" name="sapCode"></td>
                <td class="px-4 py-2"><input type="number" step="0.01" class="w-full rounded-md border-gray-300 shadow-sm" name="invoicePrice" oninput="calculateRow(this)"></td>
                <td class="px-4 py-2"><input type="number" step="0.01" class="w-full rounded-md border-gray-300 shadow-sm" name="offeredPrice" oninput="calculateRow(this)"></td>
                <td class="px-4 py-2"><input type="number" step="0.01" class="w-full rounded-md border-gray-300 shadow-sm" name="adjustingAmount" readonly></td>
                <td class="px-4 py-2"><input type="number" class="w-full rounded-md border-gray-300 shadow-sm" name="quantity" oninput="calculateRow(this)"></td>
                <td class="px-4 py-2"><input type="number" step="0.01" class="w-full rounded-md border-gray-300 shadow-sm" name="amount" readonly></td>
                <td class="px-4 py-2"><button type="button" class="text-red-600 hover:text-red-800" onclick="removeRow(this)">Remove</button></td>
              </tr>
            </tbody>
          </table>
        </div>
        <button type="button" class="mt-2 bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700" onclick="addRow()">Add Item</button>
      </div>

      <!-- Total Amount -->
      <div>
        <label class="block text-sm font-medium text-gray-700">Total Amount</label>
        <input type="number" step="0.01" id="totalAmount" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" readonly>
      </div>

      <!-- Requested By and CSO -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-medium text-gray-700">Requested By <span class="text-red-500">*</span></label>
          <input type="text" id="requestedBy" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" required>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700">Date</label>
          <input type="date" id="requestDate" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700">CSO</label>
          <input type="text" id="cso" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700">CSO Date</label>
          <input type="date" id="csoDate" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
        </div>
      </div>

      <!-- Submit and Print Buttons -->
      <div class="text-center space-x-4">
        <button type="submit" class="bg-indigo-600 text-white px-6 py-3 rounded-md hover:bg-indigo-700">Submit via Email</button>
        <button type="button" onclick="generatePDF()" class="bg-green-600 text-white px-6 py-3 rounded-md hover:bg-green-700">Print PDF</button>
      </div>
    </form>
  </div>

  <script>
    function calculateRow(input) {
      const row = input.closest('tr');
      const invoicePrice = parseFloat(row.querySelector('[name="invoicePrice"]').value) || 0;
      const offeredPrice = parseFloat(row.querySelector('[name="offeredPrice"]').value) || 0;
      const quantity = parseFloat(row.querySelector('[name="quantity"]').value) || 0;
      const adjustingAmount = invoicePrice - offeredPrice;
      const amount = adjustingAmount * quantity;

      row.querySelector('[name="adjustingAmount"]').value = adjustingAmount.toFixed(2);
      row.querySelector('[name="amount"]').value = amount.toFixed(2);
      calculateTotal();
    }

    function calculateTotal() {
      const rows = document.querySelectorAll('.item-row');
      let total = 0;
      rows.forEach(row => {
        const amount = parseFloat(row.querySelector('[name="amount"]').value) || 0;
        total += amount;
      });
      document.getElementById('totalAmount').value = total.toFixed(2);
    }

    function addRow() {
      const table = document.getElementById('itemsTable');
      const newRow = table.rows[0].cloneNode(true);
      newRow.querySelectorAll('input').forEach(input => {
        input.value = '';
        if (input.hasAttribute('readonly')) input.value = '';
      });
      table.appendChild(newRow);
    }

    function removeRow(button) {
      const row = button.closest('tr');
      if (document.querySelectorAll('.item-row').length > 1) {
        row.remove();
        calculateTotal();
      }
    }

    function generatePDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      const pageWidth = 210; // A4 width in mm
      const pageHeight = 297; // A4 height in mm
      const margin = 10; // 10mm margin
      const maxY = pageHeight - margin; // Max y position before new page
      const tableWidth = pageWidth - 2 * margin; // Table width within margins

      // Helper function to check for page overflow
      function checkPageOverflow(currentY, addHeight) {
        if (currentY + addHeight > maxY) {
          doc.addPage();
          return 10; // Reset y to top of new page
        }
        return currentY;
      }

      // Helper function to draw table borders
      function drawTableCell(x, y, width, height, text, align = 'left') {
        doc.setLineWidth(0.2);
        doc.rect(x, y - 4, width, height); // Draw cell border
        if (align === 'right') {
          doc.text(text, x + width - 2, y, { align: 'right' });
        } else {
          doc.text(text, x + 2, y);
        }
      }

      // Collect form data
      const companyName = document.getElementById('companyName').value || 'N/A';
      const accountNo = document.getElementById('accountNo').value || 'N/A';
      const contactPerson = document.getElementById('contactPerson').value || 'N/A';
      const telephone = document.getElementById('telephone').value || 'N/A';
      const fax = document.getElementById('fax').value || 'N/A';
      const salesRep = document.getElementById('salesRep').value || 'N/A';
      const invoiceNo = document.getElementById('invoiceNo').value || 'N/A';
      const invoiceDate = document.getElementById('invoiceDate').value || 'N/A';
      const reason = document.getElementById('reason').value || 'N/A';
      const followUp = document.getElementById('followUp').value || 'N/A';
      const requestedBy = document.getElementById('requestedBy').value || 'N/A';
      const requestDate = document.getElementById('requestDate').value || 'N/A';
      const cso = document.getElementById('cso').value || 'N/A';
      const csoDate = document.getElementById('csoDate').value || 'N/A';
      const totalAmount = document.getElementById('totalAmount').value || '0.00';

      // Collect items
      const items = [];
      document.querySelectorAll('.item-row').forEach(row => {
        items.push({
          sapCode: row.querySelector('[name="sapCode"]').value || 'N/A',
          invoicePrice: row.querySelector('[name="invoicePrice"]').value || '0.00',
          offeredPrice: row.querySelector('[name="offeredPrice"]').value || '0.00',
          adjustingAmount: row.querySelector('[name="adjustingAmount"]').value || '0.00',
          quantity: row.querySelector('[name="quantity"]').value || '0',
          amount: row.querySelector('[name="amount"]').value || '0.00'
        });
      });

      // PDF Content
      let y = 10;

      // Header with Logo (Use PNG fallback if SVG fails)
      try {
        doc.addImage('https://cdn-s1.lyreco.com/staticswebshop/pictures/looknfeel/common/logo.svg', 'SVG', margin, y, 40, 12);
      } catch (e) {
        console.warn('SVG logo failed to load, using fallback text');
        doc.setFontSize(11);
        doc.text('Lyreco Logo', margin, y + 6);
      }
      doc.setFontSize(16);
      doc.text('Credit Note Request Form', pageWidth / 2, y + 10, { align: 'center' });
      y += 20;

      // Section: Company Details
      let sectionHeight = doc.getTextDimensions(`Company Name: ${companyName}`, { maxWidth: 180 }).h + 6 * 5 + 8 * 2;
      y = checkPageOverflow(y, sectionHeight);
      doc.setFontSize(13);
      doc.text('Company Details', margin, y);
      doc.setLineWidth(0.5);
      doc.line(margin, y + 2, margin + 50, y + 2);
      y += 8;
      doc.setFontSize(11);
      doc.text(`Company Name: ${companyName}`, margin, y, { maxWidth: 180 });
      y += doc.getTextDimensions(`Company Name: ${companyName}`, { maxWidth: 180 }).h + 2;
      doc.text(`Account No.: ${accountNo}`, margin, y);
      y += 6;
      doc.text(`Contact Person: ${contactPerson}`, margin, y);
      y += 6;
      doc.text(`Telephone: ${telephone}`, margin, y);
      y += 6;
      doc.text(`Fax: ${fax}`, margin, y);
      y += 6;
      doc.text(`Sales Rep. / Code: ${salesRep}`, margin, y);
      y += 8;

      // Section: Invoice Details
      sectionHeight = 8 + 6 * 2 + 8;
      y = checkPageOverflow(y, sectionHeight);
      doc.setFontSize(13);
      doc.text('Invoice Details', margin, y);
      doc.line(margin, y + 2, margin + 50, y + 2);
      y += 8;
      doc.setFontSize(11);
      doc.text(`Invoice No.: ${invoiceNo}`, margin, y);
      y += 6;
      doc.text(`Invoice Date: ${invoiceDate}`, margin, y);
      y += 8;

      // Section: Notes
      const reasonHeight = doc.getTextDimensions(reason, { maxWidth: 90 }).h;
      const followUpHeight = doc.getTextDimensions(followUp, { maxWidth: 90 }).h;
      sectionHeight = 8 + 6 * 2 + reasonHeight + followUpHeight + 4 * 2 + 8;
      y = checkPageOverflow(y, sectionHeight);
      doc.setFontSize(13);
      doc.text('Notes', margin, y);
      doc.line(margin, y + 2, margin + 30, y + 2);
      y += 8;
      doc.setFontSize(11);
      doc.text('Reason for Credit Adjustment:', margin, y);
      y += 6;
      y = checkPageOverflow(y, reasonHeight + 4);
      doc.text(reason, margin, y, { maxWidth: 90 });
      y += reasonHeight + 4;
      doc.text('Follow-up Action by CSO:', margin, y);
      y += 6;
      y = checkPageOverflow(y, followUpHeight + 4);
      doc.text(followUp, margin, y, { maxWidth: 90 });
      y += followUpHeight + 8;

      // Section: Items
      sectionHeight = 8 + 8 + 8 * items.length + 4 + 8;
      y = checkPageOverflow(y, sectionHeight);
      doc.setFontSize(13);
      doc.text('Items', margin, y);
      doc.line(margin, y + 2, margin + 30, y + 2);
      y += 8;
      doc.setFontSize(11);
      const headers = ['SAP Code', 'Inv. Price', 'Off. Price', 'Adj. Amt', 'Qty', 'Amount'];
      const widths = [40, 30, 30, 30, 20, 30]; // Fixed column widths in mm
      let x = margin;
      const tableStartY = y;
      headers.forEach((header, i) => {
        drawTableCell(x, y, widths[i], 8, header, i === 0 ? 'left' : 'right');
        x += widths[i];
      });
      y += 8;

      items.forEach((item, index) => {
        y = checkPageOverflow(y, 8); // Check for each row
        x = margin;
        drawTableCell(x, y, widths[0], 8, item.sapCode, 'left');
        x += widths[0];
        drawTableCell(x, y, widths[1], 8, item.invoicePrice, 'right');
        x += widths[1];
        drawTableCell(x, y, widths[2], 8, item.offeredPrice, 'right');
        x += widths[2];
        drawTableCell(x, y, widths[3], 8, item.adjustingAmount, 'right');
        x += widths[3];
        drawTableCell(x, y, widths[4], 8, item.quantity, 'right');
        x += widths[4];
        drawTableCell(x, y, widths[5], 8, item.amount, 'right');
        y += 8;
      });

      // Draw vertical lines for table
      x = margin;
      for (let i = 0; i <= widths.length; i++) {
        doc.line(x, tableStartY - 4, x, y - 4);
        x += widths[i] || 0;
      }

      y += 4;
      y = checkPageOverflow(y, 10);
      doc.setFontSize(11);
      doc.text(`Total Amount: ${totalAmount}`, margin, y);
      y += 8;

      // Section: Approval
      sectionHeight = 8 + 6 * 4 + 8;
      y = checkPageOverflow(y, sectionHeight);
      doc.setFontSize(13);
      doc.text('Approval', margin, y);
      doc.line(margin, y + 2, margin + 40, y + 2);
      y += 8;
      doc.setFontSize(11);
      doc.text(`Requested By: ${requestedBy}`, margin, y);
      y += 6;
      doc.text(`Date: ${requestDate}`, margin, y);
      y += 6;
      doc.text(`CSO: ${cso}`, margin, y);
      y += 6;
      doc.text(`CSO Date: ${csoDate}`, margin, y);

      // Save PDF
      doc.save('Credit_Note_Request_Form.pdf');
    }

    document.getElementById('creditNoteForm').addEventListener('submit', function(e) {
      e.preventDefault();
      const form = this;

      // Validate required fields
      const requiredFields = form.querySelectorAll('[required]');
      let isValid = true;
      requiredFields.forEach(field => {
        if (!field.value.trim() || field.value.trim() === '') {
          isValid = false;
          field.classList.add('border-red-500');
        } else {
          field.classList.remove('border-red-500');
        }
      });

      if (!isValid) {
        alert('Please fill in all required fields with valid data.');
        return;
      }

      // Collect form data
      const companyName = document.getElementById('companyName').value;
      const accountNo = document.getElementById('accountNo').value;
      const contactPerson = document.getElementById('contactPerson').value;
      const telephone = document.getElementById('telephone').value;
      const fax = document.getElementById('fax').value;
      const salesRep = document.getElementById('salesRep').value;
      const invoiceNo = document.getElementById('invoiceNo').value;
      const invoiceDate = document.getElementById('invoiceDate').value;
      const reason = document.getElementById('reason').value;
      const followUp = document.getElementById('followUp').value;
      const requestedBy = document.getElementById('requestedBy').value;
      const requestDate = document.getElementById('requestDate').value;
      const cso = document.getElementById('cso').value;
      const csoDate = document.getElementById('csoDate').value;
      const totalAmount = document.getElementById('totalAmount').value;

      // Collect items
      const items = [];
      document.querySelectorAll('.item-row').forEach(row => {
        const item = {
          sapCode: row.querySelector('[name="sapCode"]').value,
          invoicePrice: row.querySelector('[name="invoicePrice"]').value,
          offeredPrice: row.querySelector('[name="offeredPrice"]').value,
          adjustingAmount: row.querySelector('[name="adjustingAmount"]').value,
          quantity: row.querySelector('[name="quantity"]').value,
          amount: row.querySelector('[name="amount"]').value
        };
        items.push(item);
      });

      // Format items for email
      const itemsText = items.map((item, index) => `
        Item ${index + 1}:
        SAP Code: ${item.sapCode}
        Invoice Price: ${item.invoicePrice}
        Offered Price: ${item.offeredPrice}
        Adjusting Amount: ${item.adjustingAmount}
        Quantity: ${item.quantity}
        Amount: ${item.amount}
      `).join('\n');

      // Create email body
      const emailBody = `
Credit Note Request Form

Company Name: ${companyName}
Account No.: ${accountNo}
Contact Person: ${contactPerson}
Telephone: ${telephone}
Fax: ${fax}
Sales Rep. / Code: ${salesRep}
Invoice No.: ${invoiceNo}
Invoice Date: ${invoiceDate}
Reason for Credit Adjustment: ${reason}
Follow-up Action by CSO: ${followUp}

Items:
${itemsText}

Total Amount: ${totalAmount}

Requested By: ${requestedBy}
Date: ${requestDate}
CSO: ${cso}
CSO Date: ${csoDate}
      `;

      // Create mailto link
      try {
        const mailtoLink = `mailto:cs.hk@lyreco.com?subject=Credit Note Request&body=${encodeURIComponent(emailBody)}`;
        window.location.href = mailtoLink;
      } catch (e) {
        alert('Failed to open email client. Please copy the form data and send it manually to cs.hk@lyreco.com.');
        console.error('Email submission failed:', e);
      }
    });
  </script>
</body>
</html>
