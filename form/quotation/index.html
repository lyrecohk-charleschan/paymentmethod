<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quotation Form</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        *,::before,::after{box-sizing:border-box;border-width:0;border-style:solid;border-color:#e2e8f0}body{margin:0;font-family:'Inter',sans-serif;color:#1e293b;line-height:1.5;background-color:#f8fafc}a{color:#2563eb;text-decoration:none}a:hover{text-decoration:underline}.container{max-width:1280px;margin-left:auto;margin-right:auto;padding:1rem}.flex{display:flex}.grid{display:grid}.hidden{display:none}.space-y-2>:not([hidden])~:not([hidden]){--tw-space-y-reverse:0;margin-top:calc(0.5rem * calc(1 - var(--tw-space-y-reverse)));margin-bottom:calc(0.5rem * var(--tw-space-y-reverse))}.space-y-4>:not([hidden])~:not([hidden]){--tw-space-y-reverse:0;margin-top:calc(1rem * calc(1 - var(--tw-space-y-reverse)));margin-bottom:calc(1rem * var(--tw-space-y-reverse))}.gap-2{gap:0.5rem}.gap-6{gap:1.5rem}.flex-col{flex-direction:column}.flex-wrap{flex-wrap:wrap}.items-start{align-items:flex-start}.items-center{align-items:center}.justify-end{justify-content:flex-end}.justify-between{justify-content:space-between}.overflow-x-auto{overflow-x:auto}.overflow-y-auto{overflow-y:auto}.rounded{border-radius:0.375rem}.rounded-lg{border-radius:0.5rem}.border{border-width:1px}.border-blue-100{border-color:#dbeafe}.border-gray-200{border-color:#e2e8f0}.border-red-500{border-color:#ef4444}.bg-blue-50{background-color:#eff6ff}.bg-gray-50{background-color:#f9fafb}.bg-white{background-color:#fff}.p-4{padding:1rem}.p-6{padding:1.5rem}.px-4{padding-left:1rem;padding-right:1rem}.py-2{padding-top:0.5rem;padding-bottom:0.5rem}.pl-4{padding-left:1rem}.pr-4{padding-right:1rem}.pt-2{padding-top:0.5rem}.text-sm{font-size:0.875rem;line-height:1.25rem}.text-lg{font-size:1.125rem;line-height:1.75rem}.text-2xl{font-size:1.5rem;line-height:2rem}.font-bold{font-weight:700}.font-medium{font-weight:500}.font-semibold{font-weight:600}.text-blue-600{color:#2563eb}.text-blue-800{color:#1e40af}.text-gray-400{color:#9ca3af}.text-gray-600{color:#4b5563}.text-gray-800{color:#1f2937}.text-red-500{color:#ef4444}.text-red-600{color:#dc2626}.shadow{box-shadow:0 1px 3px 0 rgba(0,0,0,0.1),0 1px 2px 0 rgba(0,0,0,0.06)}.shadow-lg{box-shadow:0 10px 15px -3px rgba(0,0,0,0.1),0 4px 6px -2px rgba(0,0,0,0.05)}.transition{transition-property:color,background-color,border-color,text-decoration-color,opacity,transform,box-shadow;transition-timing-function:cubic-bezier(0.4,0,0.2,1);transition-duration:150ms}.grid-cols-1{grid-template-columns:repeat(1,minmax(0,1fr))}.w-full{width:100%}.max-w-96{max-width:24rem}.h-12{height:3rem}.mt-2{margin-top:0.5rem}.mt-4{margin-top:1rem}.mt-6{margin-top:1.5rem}.mb-4{margin-bottom:1rem}.mb-6{margin-bottom:1.5rem}@media (min-width:640px){.sm\:flex-row{flex-direction:row}.sm\:grid-cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}.sm\:items-center{align-items:center}.sm\:mt-0{margin-top:0}.sm\:w-96{width:24rem}}
        .form-input{border:1px solid #e2e8f0;border-radius:0.375rem;padding:0.5rem 0.75rem;width:100%;font-size:0.875rem;transition:border-color 0.2s, box-shadow 0.2s;background-color:#fff}.form-input:hover{border-color:#3b82f6}.form-input:focus{border-color:#3b82f6;outline:none;box-shadow:0 0 0 3px rgba(59, 130, 246, 0.1)}.form-input:disabled,.form-input[readonly]{background-color:#f1f5f9;cursor:not-allowed}.form-label{display:block;font-size:0.75rem;font-weight:500;color:#475569;margin-bottom:0.25rem}.btn{display:inline-flex;align-items:center;padding:0.5rem 1rem;border-radius:0.375rem;font-size:0.875rem;font-weight:500;transition:background-color 0.2s, transform 0.1s}.btn:hover{transform:translateY(-1px)}.btn:active{transform:translateY(0)}.btn-primary{background-color:#3b82f6;color:#fff}.btn-primary:hover{background-color:#2563eb}.btn-secondary{background-color:#64748b;color:#fff}.btn-secondary:hover{background-color:#475569}.btn-success{background-color:#22c55e;color:#fff}.btn-success:hover{background-color:#16a34a}.btn-danger{background-color:#ef4444;color:#fff}.btn-danger:hover{background-color:#dc2626}.table{width:100%;border-collapse:collapse;font-size:0.875rem;background-color:#fff;border-radius:0.375rem;overflow:hidden;box-shadow:0 1px 3px rgba(0, 0, 0, 0.1)}.table th,.table td{padding:0.75rem;text-align:left;border-bottom:1px solid #e2e8f0}.table th{background-color:#f8fafc;font-weight:600;color:#475569}.table tr:hover{background-color:#f1f5f9}.search-dropdown{position:absolute;width:100%;background-color:#fff;border:1px solid #e2e8f0;border-radius:0.375rem;box-shadow:0 4px 6px rgba(0, 0, 0, 0.1);z-index:50;max-height:12rem;overflow-y:auto}.search-item{padding:0.5rem 0.75rem;font-size:0.875rem;color:#1e293b;cursor:pointer}.search-item:hover{background-color:#eff6ff;color:#2563eb}.modal{position:fixed;inset:0;background-color:rgba(0, 0, 0, 0.5);display:flex;align-items:center;justify-content:center;z-index:9999;opacity:0;visibility:hidden;transition:opacity 0.3s, visibility 0.3s}.modal.show{opacity:1;visibility:visible}.modal-content{background-color:#fff;padding:1.5rem;border-radius:0.5rem;max-width:32rem;width:100%;max-height:90vh;overflow-y:auto;transform:scale(0.95);transition:transform 0.3s;position:relative;z-index:10000;margin:0 auto}.modal.show .modal-content{transform:scale(1)}body.modal-open{overflow:hidden !important}@media (max-width:640px){.container{padding:0.5rem}.table{display:block;overflow-x:auto}.toolbar{flex-direction:column;align-items:stretch;position:sticky;top:0;width:100%}.modal-content{margin:1rem}}@media print{@page{margin:20mm}body *{visibility:hidden}.print-area,.print-area *{visibility:visible}.print-area{position:absolute;left:0;top:0;width:100%}.no-print{display:none !important}}
        .form-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(255,255,255,0.7);
            z-index: 9998;
            display: none;
            pointer-events: all;
        }
        .toolbar {
            position: sticky;
            top: 0;
            z-index: 1001;
            width: 100%;
            background: #fff;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
            padding-top: 0.5rem;
            padding-bottom: 0.5rem;
        }
        .toolbar {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            align-items: center;
            margin-bottom: 12px;
        }
        .toolbar .btn,
        .toolbar label.btn {
            margin-bottom: 0;
            cursor: pointer;
        }
        .toolbar label.btn input[type="file"] {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="formOverlay" class="form-overlay" style="display:none;"></div>
        <div class="toolbar no-print">
            <button id="firstTimeSetupBtn" class="btn btn-primary">First Setup</button>
            <label class="form-label" style="margin-right:8px;">
                <span>Form Type:</span>
                <select id="formType" class="form-input" style="width:auto;display:inline-block;margin-left:8px;">
                    <option value="QUOTATION">QUOTATION</option>
                    <option value="Proforma Invoice">Proforma Invoice</option>
                    <option value="Invoice">Invoice</option>
                    <option value="Purchasing Order">Purchasing Order</option>
                </select>
            </label>
            <button id="langToggle" class="btn btn-secondary">中文</button>
            <label class="btn btn-primary">
                Upload Product CSV
                <input type="file" id="csvFile" accept=".csv" hidden onchange="handleCSVUpload(event, 'product')">
            </label>
            <label class="btn btn-primary" id="csvUploadLabel">
                Upload Customer CSV
                <input type="file" id="customerCsvFile" accept=".csv" hidden onchange="handleCSVUpload(event, 'customer')">
            </label>
            <!-- Customer Data Source 選擇區塊移到 toolbar -->
            <div class="flex items-center ml-2" style="gap:8px;">
                <label class="form-label mb-0" for="dataSourceType" style="margin-bottom:0;">Customer Data Source</label>
                <select id="dataSourceType" class="form-input" style="width:auto;display:inline-block;">
                    <option value="csv">CSV</option>
                    <option value="json">JSON</option>
                    <option value="api">API</option>
                </select>
                <label class="form-label mb-0" id="jsonUploadLabel" style="display:none;margin-bottom:0;">
                    <input type="file" id="customerJsonFile" accept=".json,application/json" class="form-input" style="width:auto;display:inline-block;">
                </label>
                <span id="apiInputLabel" style="display:none;">
                    <input type="text" id="customerApiUrl" class="form-input" placeholder="https://api.example.com/customers" style="width:220px;display:inline-block;">
                    <button type="button" class="btn btn-primary" id="loadCustomerApiBtn">Load from API</button>
                </span>
            </div>
            <label class="btn btn-primary">
                Quick Upload Rows CSV
                <input type="file" id="quickCsvFile" accept=".csv" hidden onchange="handleQuickCSVUpload(event)">
            </label>
            <button onclick="addRow()" class="btn btn-primary">Add Row</button>
            <button onclick="clearAllRows()" class="btn btn-danger">Clear All Rows</button>
            <button onclick="saveDraft()" class="btn btn-primary">Save Draft</button>
            <button onclick="openPDFModal()" class="btn btn-success">Print PDF</button>
            <button onclick="downloadCSV()" class="btn btn-primary">Download CSV</button>
            <button onclick="exportToExcel()" class="btn btn-primary">Export Excel</button>
            <button id="downloadProductTemplate" class="btn btn-primary">Product Template</button>
            <button id="downloadCustomerTemplate" class="btn btn-primary">Customer Template</button>
            <button id="openCalculatorBtn" class="btn btn-primary">Calculator</button>
            <button id="customerDataMgmtBtn" class="btn btn-primary">Customer Data Management</button>
        </div>

        <div class="mt-4 bg-blue-50 border border-blue-100 rounded-lg p-4 text-sm text-blue-800">
            <p><strong>Step 1:</strong> Upload product & customer data (CSV)</p>
            <p><strong>Step 2:</strong> Edit quotation (add/remove product rows)</p>
            <p><strong>Step 3:</strong> Fill customer info & remarks</p>
            <p><strong>Step 4:</strong> Export PDF/CSV or save draft</p>
        </div>

        <div class="mt-6 bg-white p-6 rounded-lg shadow-lg print-area">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6">
                <!-- 公司資訊區塊已移除，僅保留下方可編輯欄位 -->
            </div>

            <div class="grid grid-cols-1 sm:grid-cols-2 gap-6 mb-6">
                <div>
                    <div class="space-y-4">
                        <label class="form-label">Payable to:
                            <input type="text" class="form-input" value="LYRECO (HONG KONG) COMPANY LIMITED" readonly>
                        </label>
                        <label class="form-label">Office Address
                            <input type="text" class="form-input" value="16th Floor, 78 Hung To Road, Kwun Tong, Kowloon, Hong Kong">
                        </label>
                        <label class="form-label">Hotline
                            <input type="text" class="form-input" value="Hotline: (852) 292462233" readonly>
                        </label>
                        <label class="form-label">FAX:
                            <input type="text" class="form-input" value="FAX: (852) 27549866" readonly>
                        </label>
                        <label class="form-label">Customer service :
                            <input type="text" class="form-input" value="Customer service : cs.hk@lyreco.com" readonly>
                        </label>
                        <div>
                            <label class="form-label" for="salesRep">Sales Representative<span class="text-red-500">*</span></label>
                            <input type="text" id="salesRep" class="form-input" value="80270192 Chan Charles" placeholder="Entry contact person" required>
                        </div>
                        <div>
                            <label class="form-label" for="salesrepPhone">Phone<span class="text-red-500">*</span></label>
                            <input type="text" id="salesrepPhone" class="form-input" value="(852) 67779473"  placeholder="Entry sales rep phone number" required>
                        </div>
                        <div>
                            <label class="form-label" for="salesrepEmail">Email<span class="text-red-500">*</span></label>
                            <input type="email" id="salesrepEmail" class="form-input" value="charles.chan@lyreco.com" placeholder="Entry sales rep email" required>
                        </div>
                    </div>
                </div>
                <div class="space-y-4">
                    <div class="relative">
                        <label class="form-label" for="customerSearch">Search Customer</label>
                        <input type="text" id="customerSearch" class="form-input" placeholder="Search by Account No., Company, or Name" oninput="searchCustomer(this)">
                        <div id="customerSearchDropdown" class="search-dropdown hidden"></div>
                    </div>
                    <div>
                        <label class="form-label" for="accountNo">Account No. <span class="text-red-500">*</span></label>
                        <input type="text" id="accountNo" class="form-input" placeholder="Enter account number" required>
                    </div>
                    <div>
                        <label class="form-label" for="quotationNo">Quotation No.</label>
                        <input type="text" id="quotationNo" class="form-input" readonly>
                    </div>
                    <div>
                        <label class="form-label" for="companyName">Company Name <span class="text-red-500">*</span></label>
                        <input type="text" id="companyName" class="form-input" placeholder="Enter company name" required>
                    </div>
                    <div>
                        <label class="form-label" for="firstName">First Name <span class="text-red-500">*</span></label>
                        <input type="text" id="firstName" class="form-input" placeholder="Enter first name">
                    </div>
                    <div>
                        <label class="form-label" for="lastName">Last Name <span class="text-red-500">*</span></label>
                        <input type="text" id="lastName" class="form-input" placeholder="Enter last name">
                    </div>
                    <div>
                        <label class="form-label" for="mobilePhone">Mobile Phone</label>
                        <input type="text" id="mobilePhone" class="form-input" placeholder="Enter mobile phone">
                    </div>
                    <div>
                        <label class="form-label" for="businessPhone">Business Phone <span class="text-red-500">*</span></label>
                        <input type="text" id="businessPhone" class="form-input" placeholder="Enter business phone">
                    </div>
                    <div>
                        <label class="form-label" for="businessEmail">Business Email</label>
                        <input type="email" id="businessEmail" class="form-input" placeholder="Enter business email">
                    </div>
                    <div>
                        <label class="form-label" for="quotationDate">Date</label>
                        <input type="date" id="quotationDate" class="form-input">
                    </div>
                    <div>
                        <label class="form-label" for="paymentTerms">Payment Terms</label>
                        <select id="paymentTerms" class="form-input">
                            <option>30 Days</option>
                            <option>60 Days</option>
                            <option>90 Days</option>
                            <option>Immediate</option>
                        </select>
                    </div>
                    <div>
                        <label class="form-label" for="validUntil">Valid Until</label>
                        <input type="date" id="validUntil" class="form-input">
                    </div>
                    <div>
                        <label class="form-label" for="address">Billing/Delivery Address <span class="text-red-500">*</span></label>
                        <textarea id="address" class="form-input" rows="3" placeholder="Enter billing/delivery address" required></textarea>
                    </div>
                    <div>
                        <label class="form-label" for="customerType">Customer Type</label>
                        <select id="customerType" class="form-input">
                            <option value="corporate">Corporate</option>
                            <option value="school">School</option>
                            <option value="government">Government</option>
                            <option value="flash">Flash Order</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="overflow-x-auto">
                <table class="table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Image</th>
                            <th>Item Code</th>
                            <th>Description</th>
                            <th>Unit</th>
                            <th style="display:none;">Package Unit</th>
                            <th>Qty</th>
                            <th>Unit Price</th>
                            <th>Amount</th>
                            <th>Remarks</th>
                            <th class="no-print">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="quotationBody"></tbody>
                </table>
            </div>

            <div class="flex justify-end mt-6">
                <div class="w-full sm:w-96 bg-gray-50 p-6 rounded-lg">
                    <div class="space-y-2">
                        <div class="flex justify-between">
                            <span>Subtotal:</span>
                            <span id="subtotal" class="font-medium">0.00</span>
                        </div>
                        <div class="flex justify-between">
                            <label for="discount" class="form-label">Discount (%):</label>
                            <input type="number" id="discount" class="form-input w-24 text-right" value="0" min="0" max="100" step="0.01" onchange="updateTotals()">
                        </div>
                        <div class="flex justify-between">
                            <span>Discount Amount:</span>
                            <span id="discountAmount" class="font-medium">0.00</span>
                        </div>
                        <div class="flex justify-between">
                            <label for="taxRate" class="form-label">Tax Rate (%):</label>
                            <input type="number" id="taxRate" class="form-input w-24 text-right" value="0" min="0" max="100" step="0.01" onchange="updateTotals()">
                        </div>
                        <div class="flex justify-between">
                            <span>Tax:</span>
                            <span id="taxAmount" class="font-medium">0.00</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <label for="deposit" class="form-label">Deposit (%):</label>
                            <input type="number" id="deposit" class="form-input w-24 text-right" value="0" min="0" max="100" step="0.01" onchange="updateTotals();updateDepositAmount()">
                            <span id="depositAmountLabel" class="ml-2 text-sm text-gray-600"></span>
                        </div>
                        <div class="flex justify-between items-center">
                            <label for="additionalCharge" class="form-label">Additional Charge (%):</label>
                            <input type="number" id="additionalCharge" class="form-input w-24 text-right" value="0" min="0" max="100" step="0.01" onchange="updateTotals();updateAdditionalChargeAmount()">
                            <span id="additionalChargeAmountLabel" class="ml-2 text-sm text-gray-600"></span>
                        </div>
                        <div class="flex justify-between">
                            <label for="freight" class="form-label">Freight:</label>
                            <input type="number" id="freight" class="form-input w-24 text-right" value="0" min="0" step="0.01" onchange="updateTotals()">
                        </div>
                        <div class="flex justify-between font-bold text-blue-600">
                            <span>Grand Total:</span>
                            <span id="grandTotal" class="font-bold">0.00</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="mt-6">
                <label for="remarks" class="form-label">Remarks</label>
                <textarea id="remarks" class="form-input" rows="4" placeholder="Enter remarks (if any)"></textarea>
                <button onclick="applySuggestedTerms()" class="btn btn-primary mt-2">Apply Suggested Terms</button>
            </div>
            <div class="mt-6">
                <label class="form-label" for="deliveryTerms">Delivery Terms</label>
                <textarea type="text" id="deliveryTerms" class="form-input" rows="4" placeholder="Enter delivery terms"></textarea>
            </div>

            <div class="mt-6">
                <label for="qrLink" class="form-label">QR Code Link</label>
                <input type="text" id="qrLink" class="form-input" placeholder="Enter URL for QR code">
                <div id="qrcode" class="mt-2"></div>
            </div>
        </div>
    </div>

    <div id="pdfModal" class="modal">
        <div class="modal-content">
            <h2 class="text-lg font-semibold mb-4">Generate PDF</h2>
            <p class="text-sm text-gray-600 mb-4">Confirm to generate the quotation PDF.</p>
            <div class="flex justify-end gap-2">
                <button class="btn btn-danger" onclick="closePDFModal()">Cancel</button>
                <button class="btn btn-success" onclick="confirmGeneratePDF()">Confirm</button>
            </div>
        </div>
    </div>

    <div id="editModal" class="modal">
        <div class="modal-content">
            <h2 class="text-lg font-semibold mb-4">Edit Row</h2>
            <div class="space-y-4">
                <div>
                    <label class="form-label" for="editItemCode">Item Code</label>
                    <input type="text" id="editItemCode" class="form-input">
                </div>
                <div>
                    <label class="form-label" for="editDescription">Description</label>
                    <textarea id="editDescription" class="form-input" rows="2"></textarea>
                </div>
                <div>
                    <label class="form-label" for="editUnit">Unit</label>
                    <input type="text" id="editUnit" class="form-input">
                </div>
                <div>
                    <label class="form-label" for="editPackageUnit">Package Unit</label>
                    <input type="number" id="editPackageUnit" class="form-input" min="1" onchange="updateEditModalAmountAndMC()">
                </div>
                <div>
                    <label class="form-label" for="editAmount">Amount</label>
                    <input type="number" id="editAmount" class="form-input" readonly>
                </div>
                <div>
                    <label class="form-label" for="editQty">Quantity</label>
                    <input type="number" id="editQty" class="form-input" min="1" onchange="updateEditModalAmountAndMC()">
                </div>
                <div>
                    <label class="form-label" for="editUnitPrice">Unit Price</label>
                    <input type="number" id="editUnitPrice" class="form-input" min="0" step="0.01" onchange="updateEditModalAmountAndMC()">
                </div>
                <div>
                    <label class="form-label">CM</label>
                    <div id="editCmName" style="font-weight:bold;color:#1e40af;"></div>
                </div>
            </div>
            <div class="flex justify-end gap-2 mt-4">
                <button class="btn btn-danger" onclick="closeEditModal()">Cancel</button>
                <button class="btn btn-success" onclick="saveEdit()">Save</button>
            </div>
        </div>
    </div>

    <div id="csvPreviewModal" class="modal">
        <div class="modal-content">
            <h2 class="text-lg font-semibold mb-4">CSV Preview</h2>
            <div id="csvPreviewError" class="text-red-600 text-sm mb-4"></div>
            <div id="csvPreviewTable" class="overflow-x-auto"></div>
            <div class="flex justify-end gap-2 mt-4">
                <button id="csvPreviewCancelBtn" class="btn btn-danger">Cancel</button>
                <button id="csvPreviewApplyBtn" class="btn btn-success">Apply</button>
            </div>
        </div>
    </div>

    <div id="firstTimeModal" class="modal show">
        <div class="modal-content">
            <h2 class="text-lg font-semibold mb-4">Welcome! Please complete setup</h2>
            <button id="firstTimeSetupBtn" class="btn btn-primary mb-4" type="button">First Setup</button>
            <div class="space-y-4">
                <label class="form-label">Upload Product CSV
                    <input type="file" id="firstTimeProductCsv" accept=".csv" class="form-input" style="margin-top:8px">
                </label>
                <button id="firstTimeDownloadProductTemplate" class="btn btn-primary mb-2" type="button">Download Product Template</button>
                <label class="form-label">Sales Representative
                    <input type="text" id="salesRep" class="form-input" value="80270192 Chan Charles" placeholder="Enter name">
                </label>
                <label class="form-label">Phone
                    <input type="text" id="salesrepPhone" class="form-input" value="(852)6777 9473" placeholder="Enter phone number">
                </label>
                <label class="form-label">Email
                    <input type="email" id="salesrepEmail" class="form-input" value="charles.chan@lyreco.com" placeholder="Enter email address">
                </label>
                <div id="firstTimeError" class="text-red-600 text-sm"></div>
            </div>
            <div class="flex justify-end gap-2 mt-4">
                <button id="firstTimeSubmitBtn" class="btn btn-success">Submit</button>
            </div>
        </div>
    </div>

    <div id="calculatorModal" class="modal">
        <div class="modal-content" style="max-width:480px; position:relative; padding-bottom:72px;">
            <button onclick="closeCalculatorModal()" style="position:absolute;top:12px;right:12px;background:none;border:none;font-size:1.5rem;cursor:pointer;" title="Close">&times;</button>
            <h2 class="text-lg font-semibold mb-4">Calculator</h2>
            <!-- 結果區塊置頂，重點數值大字顯示 -->
            <div class="mb-4 p-3 rounded-lg bg-blue-100 border border-blue-300 flex flex-wrap gap-4 items-center justify-between">
                <div class="flex flex-col items-center">
                    <span class="text-xs text-gray-500">SP</span>
                    <span id="resultSP" class="text-2xl font-bold text-blue-700 cursor-pointer" title="Copy" onclick="copyCalcResult('resultSP')"></span>
                </div>
                <div class="flex flex-col items-center">
                    <span class="text-xs text-gray-500">Margin%</span>
                    <span id="resultMargin" class="text-2xl font-bold text-blue-700 cursor-pointer" title="Copy" onclick="copyCalcResult('resultMargin')"></span>
                </div>
                <div class="flex flex-col items-center">
                    <span class="text-xs text-gray-500">Markup%</span>
                    <span id="resultMarkup" class="text-2xl font-bold text-blue-700 cursor-pointer" title="Copy" onclick="copyCalcResult('resultMarkup')"></span>
                </div>
                <div class="flex flex-col items-center">
                    <span class="text-xs text-gray-500">Cash Margin</span>
                    <span id="resultCashMargin" class="text-2xl font-bold text-blue-700 cursor-pointer" title="Copy" onclick="copyCalcResult('resultCashMargin')"></span>
                </div>
                <div class="flex flex-col items-center">
                    <span class="text-xs text-gray-500">CM</span>
                    <span id="resultNameCM" class="text-2xl font-bold text-blue-700 cursor-pointer" title="Copy" onclick="copyCalcResult('resultNameCM')"></span>
                </div>
                <div class="flex flex-col items-center">
                    <span class="text-xs text-gray-500">Margin區間</span>
                    <span id="resultMarginRange" class="text-lg font-semibold text-blue-600"></span>
                </div>
            </div>
            <!-- 常用欄位 -->
            <div class="mb-2 space-y-2">
                <div class="flex flex-wrap gap-4 mb-2 pb-2 border-b border-gray-200">
                    <div class="flex items-center" style="min-width: 200px;">
                        <span style="width:100px;">Cost</span>
                        <input type="number" id="calcCost" class="form-input" step="any" style="width:100px;" placeholder="0.00">
                        <span class="ml-1 text-xs text-gray-400">HKD</span>
                    </div>
                    <div class="flex items-center" style="min-width: 200px;">
                        <span style="width:100px;">Selling Price</span>
                        <input type="number" id="calcSP" class="form-input" step="any" style="width:100px;" placeholder="0.00">
                        <span class="ml-1 text-xs text-gray-400">HKD</span>
                    </div>
                    <div class="flex items-center" style="min-width: 200px;">
                        <span style="width:100px;">Margin (%)</span>
                        <input type="number" id="calcMargin" class="form-input" step="any" style="width:100px;" placeholder="0.00">
                        <span class="ml-1 text-xs text-gray-400">%</span>
                    </div>
                    <div class="flex items-center" style="min-width: 200px;">
                        <span style="width:100px;">Markup (%)</span>
                        <input type="number" id="calcMarkup" class="form-input" step="any" style="width:100px;" placeholder="0.00">
                        <span class="ml-1 text-xs text-gray-400">%</span>
                    </div>
                </div>
                <!-- 進階欄位可收合 -->
                <details class="mb-2">
                    <summary class="cursor-pointer text-blue-700 font-semibold">進階欄位</summary>
                    <div class="flex flex-wrap gap-4 mt-2">
                        <div class="flex items-center" style="min-width: 200px;">
                            <span style="width:100px;">Cash Margin</span>
                            <input type="number" id="calcCashMargin" class="form-input" step="any" style="width:100px;" placeholder="0.00">
                            <span class="ml-1 text-xs text-gray-400">HKD</span>
                        </div>
                        <div class="flex items-center" style="min-width: 200px;">
                            <span style="width:100px;">CM</span>
                            <input type="text" id="calcNameCMInput" class="form-input" maxlength="2" style="width:40px;display:inline-block;" placeholder="00">
                            <span id="calcNameCM" style="margin-left:4px;font-weight:bold;color:#1e40af;"></span>
                            <span id="nameCMExplain" style="margin-left:8px;color:#888;font-size:0.9em;"></span>
                        </div>
                        <div class="flex items-center" style="min-width: 200px;">
                            <span style="width:100px;">Price by Margin</span>
                            <input type="number" id="calcPriceByMargin" class="form-input" step="any" style="width:100px;" placeholder="0.00" readonly>
                            <span class="ml-1 text-xs text-gray-400">HKD</span>
                        </div>
                        <div class="flex items-center" style="min-width: 200px;">
                            <span style="width:100px;">Price by Markup</span>
                            <input type="number" id="calcPriceByMarkup" class="form-input" step="any" style="width:100px;" placeholder="0.00" readonly>
                            <span class="ml-1 text-xs text-gray-400">HKD</span>
                        </div>
                    </div>
                </details>
            </div>
            <div class="mt-4 space-y-1 text-base bg-blue-100 rounded p-3 border border-blue-300 shadow">
                <div id="calcResultSummary" class="font-bold text-blue-800"></div>
                <div id="calcResultDetail" class="text-gray-800"></div>
            </div>
            <!-- 底部按鈕區固定 -->
            <div class="flex justify-end gap-2 mt-4" style="position:absolute;bottom:16px;right:24px;left:24px;">
                <button class="btn btn-secondary" onclick="cleanCalculatorModal()">Clean</button>
                <button class="btn btn-danger" onclick="closeCalculatorModal()">Close</button>
            </div>
        </div>
        <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
        <script>
        function copyCalcResult(id) {
            const el = document.getElementById(id);
            if (!el) return;
            const val = el.textContent || el.innerText;
            if (!val) return;
            navigator.clipboard.writeText(val);
            el.classList.add('bg-green-200');
            el.title = 'Copied!';
            setTimeout(() => { el.classList.remove('bg-green-200'); el.title = 'Copy'; }, 1000);
        }
        </script>
    </div>
    <style>
        #calculatorModal .form-input {
            font-size: 1rem;
            padding: 0.5rem 0.75rem;
            border-radius: 0.5rem;
            border: 1.5px solid #dbeafe;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        #calculatorModal .form-input:focus {
            border-color: #2563eb;
            box-shadow: 0 0 0 2px #93c5fd;
        }
        #calculatorModal .btn-secondary[title='Copied!'] {
            background: #22c55e;
            color: #fff;
        }
    </style>
    <script>
        let productDatabase = [];
        let rowCounter = 1;
        let currentEditRow = null;
        let customerDatabase = [];
        let lang = 'en';
        let csvPreviewType = null;
        let csvPreviewData = null;

        const predefinedProducts = [
            { itemCode: "6344598", description: "LAVAZZA TOP CLASS COFFEE BEAN POUCH 1KG", descriptionChi: "LAVAZZA 顶级咖啡豆袋 1公斤", unit: "EA", packageUnit: "1", unitPrice: 292.00 }
        ];

        const predefinedCustomer = {
            accountNo: "",
            companyName: "",
            firstName: "",
            lastName: "",
            mobilePhone: "",
            address: "",
            quotationNo: "",
            quotationDate: "",
            validUntil: "",
            salesRep: "",
            customerType: ""
        };

        const LANGS = {
            en: {
                step1: "Step 1: Upload product & customer data (CSV)",
                step2: "Step 2: Edit quotation (add/remove product rows)",
                step3: "Step 3: Fill customer info & remarks",
                step4: "Step 4: Export PDF/CSV or save draft",
                addRow: "Add Row",
                clearAllRows: "Clear All Rows",
                quickUpload: "Quick Upload Rows CSV",
                printPDF: "Print PDF",
                downloadCSV: "Download CSV",
                saveDraft: "Save Draft",
                saved: "Draft saved!",
                restore: "Draft restored.",
                csvPreview: "CSV Preview",
                cancel: "Cancel",
                apply: "Apply",
                csvFormatError: "CSV format error: Please check column count.",
                quickCsvFormatError: "CSV must have columns: itemCode, qty, unitPrice.",
                fieldRequired: "This field is required.",
                selectProduct: "Please select or enter a product.",
                enterQty: "Please enter quantity.",
                noCustomers: "No customer data loaded. Please upload a customer CSV.",
                enterRowCount: "Enter number of rows to add (1-100):",
                invalidRowCount: "Please enter a valid number between 1 and 100."
            },
            zh: {
                step1: "步骤 1：上传产品及客户资料（CSV）",
                step2: "步骤 2：编辑报价单内容（可新增/删除产品行）",
                step3: "步骤 3：填写客户资料及备注",
                step4: "步骤 4：输出 PDF 或 CSV，或保存草稿",
                addRow: "新增产品行",
                clearAllRows: "清除所有行",
                quickUpload: "快速上传行 CSV",
                printPDF: "打印 PDF",
                downloadCSV: "下载 CSV",
                saveDraft: "保存草稿",
                saved: "草稿已保存！",
                restore: "草稿已还原。",
                csvPreview: "CSV 预览",
                cancel: "取消",
                apply: "应用",
                csvFormatError: "CSV 格式错误：请检查栏位数。",
                quickCsvFormatError: "CSV 必须包含栏位：itemCode, qty, unitPrice。",
                fieldRequired: "此栏位必填。",
                selectProduct: "请选择或输入产品。",
                enterQty: "请输入数量。",
                noCustomers: "未加载客户数据。请上传客户 CSV 文件。",
                enterRowCount: "输入要添加的行数（1-100）：",
                invalidRowCount: "请输入 1 到 100 之间的有效数字。"
            }
        };

        function setLang(newLang) {
            lang = newLang;
            document.getElementById('langToggle').textContent = lang === 'en' ? '中文' : 'English';
            const steps = document.querySelectorAll('.bg-blue-50 p');
            steps[0].innerHTML = `<strong>Step 1:</strong> ${LANGS[lang].step1}`;
            steps[1].innerHTML = `<strong>Step 2:</strong> ${LANGS[lang].step2}`;
            steps[2].innerHTML = `<strong>Step 3:</strong> ${LANGS[lang].step3}`;
            steps[3].innerHTML = `<strong>Step 4:</strong> ${LANGS[lang].step4}`;
            document.getElementById('companyName').placeholder = lang === 'en' ? 'Enter company name' : '输入公司名称';
            document.getElementById('firstName').placeholder = lang === 'en' ? 'Enter first name' : '输入名字';
            document.getElementById('lastName').placeholder = lang === 'en' ? 'Enter last name' : '输入姓氏';
            document.getElementById('address').placeholder = lang === 'en' ? 'Enter billing/delivery address' : '输入账单/送货地址';
            document.getElementById('remarks').placeholder = lang === 'en' ? 'Enter remarks (if any)' : '请输入备注（如有）';
            document.getElementById('customerSearch').placeholder = lang === 'en' ? 'Search by Account No., Company, or Name' : '按账户编号、公司或名称搜索';
        }

        function toggleLang() {
            setLang(lang === 'en' ? 'zh' : 'en');
        }

        function generateQuotationNo() {
            const formType = document.getElementById('formType')?.value || 'QUOTATION';
            let prefix = 'LY-';
            if (formType === 'QUOTATION') prefix = 'LY-';
            else if (formType === 'Proforma Invoice') prefix = 'PF-I-';
            else if (formType === 'Invoice') prefix = 'INV-';
            else if (formType === 'Purchasing Order') prefix = 'PO-';
            const num = Math.floor(Math.random() * 1e10);
            return `${prefix}${String(num).padStart(10, '0')}`;
        }

        function updateQuotationNoAndLabel() {
            const formType = document.getElementById('formType')?.value || 'QUOTATION';
            const labelMap = {
                'QUOTATION': 'Quotation No.',
                'Proforma Invoice': 'Proforma invoice No.',
                'Invoice': 'Invoice No.',
                'Purchasing Order': 'Purchasing Order No.'
            };
            document.querySelector('label[for="quotationNo"]').textContent = labelMap[formType] || 'Quotation No.';
            document.getElementById('quotationNo').value = generateQuotationNo();
        }

        function searchCustomer(input) {
            const keyword = input.value.toLowerCase();
            const dropdown = document.getElementById('customerSearchDropdown');
            if (!keyword || customerDatabase.length === 0) {
                dropdown.classList.add('hidden');
                if (customerDatabase.length === 0 && keyword) {
                    showToast(LANGS[lang].noCustomers);
                }
                return;
            }
            // 新增多關鍵字搜尋（空格分割 tokens，每個 token 都要 match 任一欄位）
            const tokens = keyword.split(/\s+/).filter(Boolean);
            const matches = customerDatabase.filter(c =>
                tokens.every(token =>
                    [
                        c.accountNo, c.firstName, c.lastName, c.companyName,
                        c.businessPhone, c.mobilePhone, c.businessEmail,
                        c.flat, c.building, c.street, c.district, c.city
                    ].some(field => String(field || '').toLowerCase().includes(token))
                )
            );
            dropdown.innerHTML = matches.map(c => `
                <div class="search-item" onclick="selectCustomer('${String(c.accountNo||'').replace(/'/g, "\\'")}', '${String(c.companyName||'').replace(/'/g, "\\'")}', '${String(c.firstName||'').replace(/'/g, "\\'")}', '${String(c.lastName||'').replace(/'/g, "\\'")}', '${String(c.businessPhone||'').replace(/'/g, "\\'")}', '${String(c.mobilePhone||'').replace(/'/g, "\\'")}', '${String(c.businessEmail||'').replace(/'/g, "\\'")}', '${String(c.flat||'').replace(/'/g, "\\'")}', '${String(c.building||'').replace(/'/g, "\\'")}', '${String(c.street||'').replace(/'/g, "\\'")}', '${String(c.district||'').replace(/'/g, "\\'")}', '${String(c.city||'').replace(/'/g, "\\'")}', '${String(c.zipCode||'').replace(/'/g, "\\'")}' )">
                    <div><b>${c.companyName}</b> (${c.accountNo})</div>
                    <div>Name: ${c.firstName} ${c.lastName}</div>
                    <div>Business Phone: ${c.businessPhone} | Mobile: ${c.mobilePhone}</div>
                    <div>Email: ${c.businessEmail}</div>
                    <div>Address: ${[c.flat, c.building, c.street, c.district, c.city, c.zipCode].filter(Boolean).join(', ')}</div>
                </div>
            `).join('');
            dropdown.classList.toggle('hidden', matches.length === 0);
        }

        function selectCustomer(accountNo, companyName, firstName, lastName, businessPhone, mobilePhone, businessEmail, flat, building, street, district, city, zipCode) {
            document.getElementById('accountNo').value = accountNo;
            document.getElementById('companyName').value = companyName;
            document.getElementById('firstName').value = firstName;
            document.getElementById('lastName').value = lastName;
            document.getElementById('businessPhone').value = businessPhone;
            document.getElementById('mobilePhone').value = mobilePhone;
            document.getElementById('businessEmail').value = businessEmail;
            document.getElementById('address').value = [flat, building, street, district, city, zipCode].filter(Boolean).join(', ');
            document.getElementById('customerSearch').value = '';
            document.getElementById('customerSearchDropdown').classList.add('hidden');
        }

        function handleCSVUpload(event, type) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                showCSVPreview(type, e.target.result);
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        function handleQuickCSVUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                processQuickCSV(e.target.result);
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        function parseCSV(csvData) {
            const parsed = Papa.parse(csvData, { header: true, skipEmptyLines: true });
            return parsed.data.map(row => ({
                itemCode: row.itemCode?.trim() || '',
                description: row.descriptionEng?.trim() || '',
                descriptionChi: row.descriptionChi?.trim() || '',
                unit: row.unit?.trim() || '',
                packageUnit: row.packageUnit?.trim() || '1',
                unitPrice: parseFloat(row.unitPrice) || 0,
                cost: parseFloat(row.cost) || 0
            }));
        }

        function parseCustomerCSV(csvData) {
            const parsed = Papa.parse(csvData, { header: true, skipEmptyLines: true });
            return parsed.data.map(row => ({
                accountNo: row.accountNo?.trim() || '',
                companyName: row.companyName?.trim() || '',
                firstName: row.firstName?.trim() || '',
                lastName: row.lastName?.trim() || '',
                businessPhone: row.businessPhone?.trim() || '',
                mobilePhone: row.mobilePhone?.trim() || '',
                businessEmail: row.businessEmail?.trim() || '',
                flat: row.flat?.trim() || row["Name 2"]?.trim() || '',
                building: row.building?.trim() || row["Name 3"]?.trim() || '',
                street: row.street?.trim() || '',
                district: row.district?.trim() || '',
                city: row.city?.trim() || '',
                zipCode: row.zipCode?.trim() || '000',
            }));
        }

        function parseQuickCSV(csvData) {
            const parsed = Papa.parse(csvData, { header: true, skipEmptyLines: true });
            // 支援多種標題名稱
            return parsed.data.map(row => ({
                itemCode: row.itemCode?.trim() || row["Item Code"]?.trim() || row["item code"]?.trim() || '',
                qty: parseFloat(row.qty || row["Qty"] || row["qty"] || 1) || 1,
                unitPrice: parseFloat(row.unitPrice || row["Unit Price"] || row["unit price"] || 0) || 0
            }));
        }

        function processQuickCSV(csvData) {
            const parsed = parseQuickCSV(csvData);
            // 只要有 itemCode, qty, unitPrice 就接受
            const validRows = parsed.filter(row => row.itemCode && row.qty > 0);
            if (validRows.length === 0) {
                showToast(LANGS[lang].quickCsvFormatError);
                return;
            }
            validRows.forEach(row => {
                addRowFromCSV(row);
            });
            updateTotals();
            showToast(`${validRows.length} rows added from CSV.`);
        }

        function showCSVPreview(type, csvData) {
            csvPreviewType = type;
            csvPreviewData = csvData;
            const parsed = Papa.parse(csvData, { header: true, skipEmptyLines: true });
            if (parsed.errors.length > 0) {
                document.getElementById('csvPreviewError').textContent = LANGS[lang].csvFormatError;
                document.getElementById('csvPreviewApplyBtn').disabled = true;
                document.getElementById('csvPreviewTable').innerHTML = '';
                document.getElementById('csvPreviewModal').classList.add('show');
                return;
            }
            const headers = parsed.meta.fields;
            const rows = parsed.data;
            let table = `<table class="table"><thead><tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr></thead><tbody>${rows.map(r => `<tr>${headers.map(h => `<td>${r[h] || ''}</td>`).join('')}</tr>`).join('')}</tbody></table>`;
            document.getElementById('csvPreviewTable').innerHTML = table;
            document.getElementById('csvPreviewError').textContent = '';
            document.getElementById('csvPreviewApplyBtn').disabled = false;
            document.getElementById('csvPreviewModal').classList.add('show');
        }

        function closeCSVPreviewModal() {
            document.getElementById('csvPreviewModal').classList.remove('show');
            csvPreviewType = null;
            csvPreviewData = null;
        }

        function applyCSVPreview() {
            if (csvPreviewType === 'product') {
                productDatabase = parseCSV(csvPreviewData);
                document.getElementById('quotationBody').innerHTML = '';
                rowCounter = 1;
                addRow();
            } else if (csvPreviewType === 'customer') {
                customerDatabase = parseCustomerCSV(csvPreviewData);
            }
            closeCSVPreviewModal();
        }

        function addRow() {
            const input = prompt(LANGS[lang].enterRowCount, '1');
            if (input === null) return; // User clicked Cancel
            const numRows = parseInt(input, 10);
            if (isNaN(numRows) || numRows < 1 || numRows > 100) {
                showToast(LANGS[lang].invalidRowCount);
                return;
            }
            const tbody = document.getElementById('quotationBody');
            for (let i = 0; i < numRows; i++) {
                const tr = document.createElement('tr');
                tr.setAttribute('draggable', 'true');
                tr.innerHTML = `
                    <td>${rowCounter}</td>
                    <td>
                        <a class="eshop-link" href="#" target="_blank">
                            <img src="" alt="Product Image" class="w-12 h-12 rounded" onerror="this.style.display='none';if(this.nextElementSibling){this.nextElementSibling.style.display='block';}">
                        </a>
                        <span class="text-xs text-gray-400" style="display:none;">No Image</span>
                    </td>
                    <td>
                        ${productDatabase.length > 0 ? `
                            <select class="form-input item-code" onchange="updateRowDetails(this)" aria-label="Select item">
                                <option value="">Select Item</option>
                                ${productDatabase.map(p => `<option value="${p.itemCode}">${p.itemCode}</option>`).join('')}
                            </select>
                        ` : `
                            <input type="text" class="form-input item-code" placeholder="Enter item code" aria-label="Item code">
                        `}
                        <div class="relative mt-2">
                            <input type="text" class="form-input" placeholder="Search by Description & Item Code" oninput="searchByDescription(this)">
                            <div class="search-dropdown hidden"></div>
                        </div>
                    </td>
                    <td><textarea class="form-input description" rows="2" placeholder="Enter description"></textarea></td>
                    <td><input type="text" class="form-input unit" placeholder="Enter unit"></td>
                    <td><input type="number" class="form-input package-unit" value="1" min="1" onchange="calculateRowAmount(this)" placeholder="Pkg Unit"></td>
                    <td><input type="number" class="form-input qty" value="1" min="1" onchange="calculateRowAmount(this)" aria-label="Quantity"></td>
                    <td><input type="number" class="form-input unit-price text-right" step="0.01" min="0" onchange="calculateRowAmount(this)" placeholder="Enter unit price"></td>
                    <td><input type="number" class="form-input amount text-right" readonly></td>
                    <td><input type="text" class="form-input remarks" placeholder="Remarks" aria-label="Remarks"></td>
                    <td class="no-print">
                        <div class="flex gap-2">
                            <button onclick="openEditModal(this)" class="btn btn-secondary" title="Edit">Edit</button>
                            <button onclick="removeRow(this)" class="btn btn-danger" title="Remove">Remove</button>
                            <button onclick="showInternalInfo(this)" class="btn btn-success" title="Internal">Internal</button>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
                rowCounter++;
            }
            document.querySelector('#quotationBody .item-code')?.focus();
            showToast(`${numRows} row${numRows > 1 ? 's' : ''} added.`);
            updateTotals();
        }

        function addRowFromCSV(rowData) {
            const product = productDatabase.find(p => p.itemCode === rowData.itemCode) || {};
            const tbody = document.getElementById('quotationBody');
            const tr = document.createElement('tr');
            tr.setAttribute('draggable', 'true');
            const qty = rowData.qty || 1;
            const packageUnit = product.packageUnit || 1;
            const unitPrice = rowData.unitPrice || product.unitPrice || 0;
            const amount = qty * packageUnit * unitPrice;
            tr.innerHTML = `
                <td>${rowCounter}</td>
                <td>
                    <a class="eshop-link" href="${rowData.itemCode ? `https://www.lyreco.com/webshop/HKHK/detail-product-${rowData.itemCode}.html` : '#'}" target="_blank">
                        <img src="${product.itemCode ? `https://assets.lyreco.com/is/image/lyrecows/2018-${product.itemCode}?fmt=jpg&locale=HK_hk` : ''}" alt="Product Image" class="w-12 h-12 rounded" onerror="this.style.display='none';if(this.nextElementSibling){this.nextElementSibling.style.display='block';}">
                    </a>
                    <span class="text-xs text-gray-400" style="display:${product.itemCode ? 'none' : 'block'};">No Image</span>
                </td>
                <td>
                    ${productDatabase.length > 0 ? `
                        <select class="form-input item-code" onchange="updateRowDetails(this)" aria-label="Select item">
                            <option value="">Select Item</option>
                            ${productDatabase.map(p => `<option value="${p.itemCode}" ${p.itemCode === rowData.itemCode ? 'selected' : ''}>${p.itemCode}</option>`).join('')}
                        </select>
                    ` : `
                        <input type="text" class="form-input item-code" value="${rowData.itemCode}" placeholder="Enter item code" aria-label="Item code">
                    `}
                    <div class="relative mt-2">
                        <input type="text" class="form-input" placeholder="Search by Description & Item Code" oninput="searchByDescription(this)">
                        <div class="search-dropdown hidden"></div>
                    </div>
                </td>
                <td><textarea class="form-input description" rows="2">${product.description || ''}</textarea></td>
                <td><input type="text" class="form-input unit" value="${product.unit || ''}" placeholder="Enter unit"></td>
                <td><input type="number" class="form-input package-unit" value="${packageUnit}" min="1" onchange="calculateRowAmount(this)" placeholder="Pkg Unit"></td>
                <td><input type="number" class="form-input qty" value="${rowData.qty}" min="1" onchange="calculateRowAmount(this)" aria-label="Quantity"></td>
                <td><input type="number" class="form-input unit-price text-right" value="${rowData.unitPrice || product.unitPrice || ''}" step="0.01" min="0" onchange="calculateRowAmount(this)" placeholder="Enter unit price"></td>
                <td><input type="number" class="form-input amount text-right" value="${amount.toFixed(2)}" readonly></td>
                <td><input type="text" class="form-input remarks" placeholder="Remarks" aria-label="Remarks"></td>
                <td class="no-print">
                    <div class="flex gap-2">
                        <button onclick="openEditModal(this)" class="btn btn-secondary" title="Edit">Edit</button>
                        <button onclick="removeRow(this)" class="btn btn-danger" title="Remove">Remove</button>
                        <button onclick="showInternalInfo(this)" class="btn btn-success" title="Internal">Internal</button>
                    </div>
                </td>
            `;
            tbody.appendChild(tr);
            rowCounter++;
        }

        function clearAllRows() {
            if (confirm(LANGS[lang].clearAllRows + '?')) {
                document.getElementById('quotationBody').innerHTML = '';
                rowCounter = 1;
                updateTotals();
                showToast('All rows cleared.');
            }
        }

        function removeRow(btn) {
            btn.closest('tr').remove();
            updateRowNumbers();
            updateTotals();
        }

        function updateRowNumbers() {
            document.querySelectorAll('#quotationBody tr').forEach((tr, i) => {
                tr.cells[0].textContent = i + 1;
            });
        }

        function updateRowDetails(select) {
            const row = select.closest('tr');
            const product = productDatabase.find(p => p.itemCode === select.value);
            if (product) {
                row.querySelector('.description').value = product.description.slice(0, 150);
                row.querySelector('.unit').value = product.unit;
                if (row.querySelector('.package-unit')) {
                    row.querySelector('.package-unit').value = product.packageUnit;
                }
                row.querySelector('.unit-price').value = product.unitPrice.toFixed(2);
                const qty = parseFloat(row.querySelector('.qty').value) || 0;
                const packageUnit = parseFloat(product.packageUnit) || 1;
                const unitPrice = parseFloat(product.unitPrice) || 0;
                row.querySelector('.amount').value = (qty * packageUnit * unitPrice).toFixed(2);
                const img = row.querySelector('img');
                img.src = `https://assets.lyreco.com/is/image/lyrecows/2018-${product.itemCode}?fmt=jpg&locale=HK_hk`;
                img.style.display = 'block';
                if (img.nextElementSibling) img.nextElementSibling.style.display = 'none';
                // 修正 eshop-link href
                const eshopLink = row.querySelector('.eshop-link');
                if (eshopLink) {
                    eshopLink.href = product.itemCode ? `https://www.lyreco.com/webshop/HKHK/detail-product-${product.itemCode}.html` : '#';
                }
            } else {
                row.querySelector('img').src = '';
                row.querySelector('.description').value = '';
                row.querySelector('.unit').value = '';
                if (row.querySelector('.package-unit')) {
                    row.querySelector('.package-unit').value = '1';
                }
                row.querySelector('.unit-price').value = '';
                row.querySelector('.amount').value = '';
                // 清空 eshop-link href
                const eshopLink = row.querySelector('.eshop-link');
                if (eshopLink) {
                    eshopLink.href = '#';
                }
            }
            updateTotals();
        }

        function calculateRowAmount(input) {
            const row = input.closest('tr');
            const qty = parseFloat(row.querySelector('.qty').value) || 0;
            const packageUnit = row.querySelector('.package-unit') ? parseFloat(row.querySelector('.package-unit').value) || 1 : 1;
            const unitPrice = parseFloat(row.querySelector('.unit-price').value) || 0;
            const amount = qty * packageUnit * unitPrice;
            row.querySelector('.amount').value = amount.toFixed(2);
            updateTotals();
        }

        function updateTotals() {
            let subtotal = 0;
            let totalCost = 0;
            let totalCashMargin = 0;
            document.querySelectorAll('#quotationBody tr').forEach(row => {
                const amount = parseFloat(row.querySelector('.amount')?.value) || 0;
                const qty = parseFloat(row.querySelector('.qty')?.value) || 0;
                const packageUnit = parseFloat(row.querySelector('.package-unit')?.value) || 1;
                const itemCode = row.querySelector('.item-code')?.value || '';
                const product = productDatabase.find(p => p.itemCode === itemCode) || {};
                const cost = parseFloat(product.cost) || 0;
                subtotal += amount;
                totalCost += cost * qty * packageUnit;
                totalCashMargin += amount - (cost * qty * packageUnit);
            });
            const taxRate = parseFloat(document.getElementById('taxRate').value) || 0;
            const discount = parseFloat(document.getElementById('discount').value) || 0;
            const discountAmount = (subtotal * discount / 100);
            const taxAmount = ((subtotal - discountAmount) * taxRate / 100);
            let freight = parseFloat(document.getElementById('freight').value) || 0;
            let depositPct = parseFloat(document.getElementById('deposit').value) || 0;
            let additionalChargePct = parseFloat(document.getElementById('additionalCharge').value) || 0;
            let deposit = subtotal * depositPct / 100;
            let additionalCharge = subtotal * additionalChargePct / 100;
            if (subtotal < 200 && subtotal > 0) {
                freight = 50;
                document.getElementById('freight').value = freight.toFixed(2);
            } else if (subtotal >= 200) {
                freight = 0;
                document.getElementById('freight').value = freight.toFixed(2);
            }
            const grandTotal = subtotal - discountAmount + taxAmount + freight + deposit + additionalCharge;
            document.getElementById('subtotal').textContent = subtotal.toFixed(2);
            document.getElementById('discountAmount').textContent = discountAmount.toFixed(2);
            document.getElementById('taxAmount').textContent = taxAmount.toFixed(2);
            document.getElementById('grandTotal').textContent = grandTotal.toFixed(2);
            updateDepositAmount();
            updateAdditionalChargeAmount();
            // 顯示 Overall Margin
            let overallMargin = subtotal > 0 ? ((subtotal - totalCost) / subtotal * 100) : 0;
            let overallMarginDiv = document.getElementById('overallMarginDiv');
            if (!overallMarginDiv) {
                overallMarginDiv = document.createElement('div');
                overallMarginDiv.id = 'overallMarginDiv';
                overallMarginDiv.className = 'flex justify-between mt-2 font-bold text-blue-600';
                document.querySelector('.w-full.sm\\:w-96.bg-gray-50.p-6.rounded-lg').appendChild(overallMarginDiv);
            }
            overallMarginDiv.innerHTML = `<span>Overall Margin:</span><span>${overallMargin.toFixed(1)}%</span>`;
        }

        let dragSrcRow = null;
        document.getElementById('quotationBody').addEventListener('dragstart', e => {
            dragSrcRow = e.target.closest('tr');
            dragSrcRow.style.opacity = '0.5';
        });
        document.getElementById('quotationBody').addEventListener('dragend', () => {
            if (dragSrcRow) dragSrcRow.style.opacity = '';
            dragSrcRow = null;
        });
        document.getElementById('quotationBody').addEventListener('dragover', e => e.preventDefault());
        document.getElementById('quotationBody').addEventListener('drop', e => {
            e.preventDefault();
            if (dragSrcRow && dragSrcRow !== e.target.closest('tr')) {
                const targetRow = e.target.closest('tr');
                if (targetRow) {
                    document.getElementById('quotationBody').insertBefore(dragSrcRow, targetRow.nextSibling);
                    updateRowNumbers();
                    updateTotals();
                }
            }
            dragSrcRow = null;
        });

        function searchByDescription(input) {
            const row = input.closest('tr');
            const keyword = input.value.toLowerCase();
            const dropdown = row.querySelector('.search-dropdown');
            if (!keyword) {
                dropdown.classList.add('hidden');
                return;
            }
            // 多關鍵字搜尋：每個 token 都要 match 任一欄位
            const tokens = keyword.split(/\s+/).filter(Boolean);
            const matches = productDatabase.filter(p =>
                tokens.every(token =>
                    p.description.toLowerCase().includes(token) ||
                    p.itemCode.toLowerCase().includes(token) ||
                    p.descriptionChi.toLowerCase().includes(token)
                )
            );
            dropdown.innerHTML = matches.map(p => `
                <div class="search-item" onclick="selectDescription(this, '${p.itemCode.replace(/'/g, "\\'")}')">
                    ${p.itemCode} - ${p.description} (${p.descriptionChi})
                </div>
            `).join('');
            dropdown.classList.toggle('hidden', matches.length === 0);
        }

        function selectDescription(div, itemCode) {
            const row = div.closest('tr');
            const select = row.querySelector('select.item-code');
            if (select) {
                select.value = itemCode;
                updateRowDetails(select);
            } else {
                const product = productDatabase.find(p => p.itemCode === itemCode);
                if (product) {
                    row.querySelector('.item-code').value = product.itemCode;
                    row.querySelector('.description').value = product.description;
                    row.querySelector('.unit').value = product.unit;
                    row.querySelector('.package-unit').value = product.packageUnit;
                    row.querySelector('.unit-price').value = product.unitPrice.toFixed(2);
                    calculateRowAmount(row.querySelector('.qty'));
                }
            }
            row.querySelector('.search-dropdown').classList.add('hidden');
            row.querySelector('input[type=text]').value = '';
        }

        function openEditModal(button) {
            currentEditRow = button.closest('tr');
            const modal = document.getElementById('editModal');
            if (!modal) {
                alert('Edit modal not found!');
                return;
            }
            // 強制顯示 modal
            modal.classList.add('show');
            modal.style.display = 'flex';
            // ...原本填值邏輯...
            const itemCodeInput = document.getElementById('editItemCode');
            const descriptionInput = document.getElementById('editDescription');
            const unitInput = document.getElementById('editUnit');
            const packageUnitInput = document.getElementById('editPackageUnit');
            const qtyInput = document.getElementById('editQty');
            const unitPriceInput = document.getElementById('editUnitPrice');
            const amountInput = document.getElementById('editAmount');
            const itemCode = currentEditRow.querySelector('.item-code').value;
            const product = productDatabase.find(p => p.itemCode === itemCode);
            itemCodeInput.value = itemCode;
            descriptionInput.value = currentEditRow.querySelector('.description').value || (product ? product.description : '');
            unitInput.value = currentEditRow.querySelector('.unit').value || (product ? product.unit : '');
            packageUnitInput.value = currentEditRow.querySelector('.package-unit')?.value || (product ? product.packageUnit : '1');
            qtyInput.value = currentEditRow.querySelector('.qty').value || '1';
            unitPriceInput.value = currentEditRow.querySelector('.unit-price').value || (product ? product.unitPrice.toFixed(2) : '');
            amountInput.value = currentEditRow.querySelector('.amount').value || '0.00';
            updateEditModalAmountAndMC();
        }

        function closeEditModal() {
            document.getElementById('editModal').classList.remove('show');
            currentEditRow = null;
        }

        function showFieldError(input, msg) {
            if (!input) return;
            let err = input.parentElement.querySelector('.field-error');
            if (!err) {
                err = document.createElement('div');
                err.className = 'field-error text-xs text-red-600 mt-1';
                input.parentElement.appendChild(err);
            }
            err.textContent = msg;
            input.classList.add('border-red-500');
        }
        function clearFieldError(input) {
            if (!input) return;
            let err = input.parentElement.querySelector('.field-error');
            if (err) err.remove();
            input.classList.remove('border-red-500');
        }
        function validateEditModalFields() {
            let valid = true;
            const itemCode = document.getElementById('editItemCode');
            const qty = document.getElementById('editQty');
            clearFieldError(itemCode);
            clearFieldError(qty);
            if (!itemCode.value.trim()) {
                showFieldError(itemCode, LANGS[lang].selectProduct);
                valid = false;
            }
            if (!qty.value.trim() || parseInt(qty.value) < 1) {
                showFieldError(qty, LANGS[lang].enterQty);
                valid = false;
            }
            return valid;
        }
        function saveEdit() {
            if (!currentEditRow) return;
            if (!validateEditModalFields()) return;
            const itemCode = document.getElementById('editItemCode').value;
            const description = document.getElementById('editDescription').value;
            const unit = document.getElementById('editUnit').value;
            const packageUnit = document.getElementById('editPackageUnit').value;
            const qty = document.getElementById('editQty').value;
            const unitPrice = document.getElementById('editUnitPrice').value;
            const amount = document.getElementById('editAmount').value;
            currentEditRow.querySelector('.item-code').value = itemCode;
            currentEditRow.querySelector('.description').value = description;
            currentEditRow.querySelector('.unit').value = unit;
            if (currentEditRow.querySelector('.package-unit')) {
                currentEditRow.querySelector('.package-unit').value = packageUnit;
            }
            currentEditRow.querySelector('.qty').value = qty;
            currentEditRow.querySelector('.unit-price').value = parseFloat(unitPrice).toFixed(2);
            currentEditRow.querySelector('.amount').value = parseFloat(amount).toFixed(2);
            // 修正 eshop-link href
            const eshopLink = currentEditRow.querySelector('.eshop-link');
            if (eshopLink) {
                eshopLink.href = itemCode ? `https://www.lyreco.com/webshop/HKHK/detail-product-${itemCode}.html` : '#';
            }
            calculateRowAmount(currentEditRow.querySelector('.qty'));
            closeEditModal();
        }
        function updateEditModalAmountAndMC() {
            const qty = parseFloat(document.getElementById('editQty').value) || 0;
            const packageUnit = parseFloat(document.getElementById('editPackageUnit').value) || 1;
            const unitPrice = parseFloat(document.getElementById('editUnitPrice').value) || 0;
            const amount = qty * packageUnit * unitPrice;
            document.getElementById('editAmount').value = amount.toFixed(2);
            // MC 計算
            const itemCode = document.getElementById('editItemCode').value;
            const product = productDatabase.find(p => p.itemCode === itemCode);
            const cost = product ? parseFloat(product.cost) || 0 : 0;
            const marginPct = amount > 0 ? ((amount - (cost * qty * packageUnit)) / amount * 100) : 0;
            let nameCM = String(Math.floor(marginPct / 5));
            if (nameCM.length === 1) nameCM = '0' + nameCM;
            let cmExplain = '';
            if (!isNaN(marginPct)) {
                const cmBand = Math.floor(marginPct / 5);
                const cmLow = (cmBand * 5).toFixed(1);
                const cmHigh = ((cmBand + 1) * 5).toFixed(1);
                cmExplain = `(${cmLow}% - ${cmHigh}%)`;
            }
            document.getElementById('editCmName').textContent = `${nameCM} ${cmExplain}`;
        }
        // Modal UX/a11y: ESC 關閉、遮罩點擊、自動 focus
        (function enhanceEditModalUX() {
            const modal = document.getElementById('editModal');
            if (!modal) return;
            // ESC 關閉
            document.addEventListener('keydown', function(e) {
                if (modal.classList.contains('show') && e.key === 'Escape') closeEditModal();
            });
            // 遮罩點擊關閉
            modal.addEventListener('mousedown', function(e) {
                if (e.target === modal) closeEditModal();
            });
            // 自動 focus
            const observer = new MutationObserver(() => {
                if (modal.classList.contains('show')) {
                    setTimeout(() => {
                        const firstInput = modal.querySelector('input,select,textarea');
                        if (firstInput) firstInput.focus();
                    }, 50);
                }
            });
            observer.observe(modal, { attributes: true, attributeFilter: ['class'] });
        })();

        async function confirmGeneratePDF() {
            const getField = id => document.getElementById(id)?.value || '';
            // 新增取得公司資訊 input 欄位的輔助函數
            function getCompanyInfoInput(idx) {
                const labels = [
                    'LYRECO (HONG KONG) COMPANY LIMITED',
                    '16th Floor, 78 Hung To Road, Kwun Tong, Kowloon, Hong Kong',
                    'Hotline: (852) 292462233',
                    'FAX: (852) 27549866',
                    'Customer service : cs.hk@lyreco.com'
                ];
                const label = labels[idx];
                const labelEls = Array.from(document.querySelectorAll('.form-label'));
                for (const el of labelEls) {
                    if (el.textContent.trim().startsWith(label)) {
                        const input = el.querySelector('input');
                        if (input) return input.value;
                    }
                }
                return label;
            }
            if (!confirm("Generate PDF for this quotation?")) return;
            showToast("Generating PDF...");
            const requiredFields = ['companyName', 'accountNo', 'address'];
            for (const id of requiredFields) {
                const field = document.getElementById(id);
                if (!field.value.trim()) {
                    showToast(LANGS[lang].fieldRequired);
                    field.focus();
                    closePDFModal();
                    return;
                }
            }
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4', encoding: 'UTF-8' });
                doc.setFontSize(8);
                // 取 input 欄位內容
                doc.text(getCompanyInfoInput(0), 8, 14);
                doc.text(getCompanyInfoInput(1), 8, 20);
                doc.text(getCompanyInfoInput(2), 8, 26);
                doc.text(getCompanyInfoInput(3), 8, 32);
                doc.text(getCompanyInfoInput(4), 8, 38);
                // Sales Rep block
                const salesRep = getField('salesRep');
                const phone = getField('salesrepPhone');
                const email = getField('salesrepEmail');
                doc.text("Sales Representative: " + salesRep, 8, 44);
                doc.text("Phone: " + phone, 8, 50);
                doc.text("Email: " + email, 8, 56);
                doc.setFontSize(8);
                // 客戶資訊
                doc.text("Customer Information", 200, 14, { align: "right" });
                doc.setFontSize(10);
                doc.text(getField('companyName'), 200, 20, { align: "right" });
                doc.text(getField('firstName') + ' ' + getField('lastName'), 200, 26, { align: "right" });
                doc.setFontSize(8);
                // 取得客戶地址，優先用手動輸入
                let addressLines = [];
                let manualAddress = getField('address').split(/\r?\n/).map(l => l.trim()).filter(Boolean);
                if (manualAddress.length > 0) {
                    addressLines = manualAddress;
                } else {
                    let accNo = getField('accountNo');
                    let customer = Array.isArray(customerDatabase) ? customerDatabase.find(c => c.accountNo === accNo) : null;
                    if (customer) {
                        const row = customer;
                        let line1 = [row.detailOne, row.detailTwo].filter(Boolean).join(', ');
                        let line2 = [row.building, row.street].filter(Boolean).join(', ');
                        let line3 = row.city || '';
                        addressLines = [line1, line2, line3].filter(line => line);
                    }
                }
                if (addressLines.length === 0) {
                    showToast(LANGS[lang].noCustomers + ' ' + (LANGS[lang].fieldRequired || 'Using default address.'));
                }
                // 動態列印 addressLines，避免 undefined
                let addressY = 32;
                for (let i = 0; i < addressLines.length; i++) {
                    doc.text(addressLines[i], 200, addressY, { align: "right" });
                    addressY += 6;
                }
                doc.text(`Account No.: ${getField('accountNo')}`, 200, addressY, { align: "right" });
                // Use selected form type
                const formType = document.getElementById('formType')?.value || 'QUOTATION';
                doc.setFontSize(16);
                doc.text(formType, 105, 58, { align: "center" });
                doc.setFontSize(10);
                doc.text(`Quotation No.: ${getField('quotationNo')}`, 200, 52, { align: "right" });
                doc.text(`Date: ${getField('quotationDate')}`, 200, 58, { align: "right" });
                doc.text(`Valid Until: ${getField('validUntil')}`, 200, 64, { align: "right" });

                let subtotal = 0;
                const tableData = [];
                const imagePromises = [];
                document.querySelectorAll("#quotationBody tr").forEach(row => {
                    const itemCode = row.querySelector(".item-code").value || '';
                    const description = row.querySelector(".description").value || '';
                    const unit = row.querySelector(".unit").value || '';
                    const packageUnitInput = row.querySelector(".package-unit");
                    const packageUnit = packageUnitInput ? parseFloat(packageUnitInput.value) || 1 : 1;
                    const unitPrice = parseFloat(row.querySelector(".unit-price").value) || 0;
                    const qty = parseFloat(row.querySelector(".qty").value) || 0;
                    const amount = parseFloat(row.querySelector(".amount").value) || 0;
                    const remarks = row.querySelector(".remarks").value || '';
                    const imgElement = row.querySelector("img");

                    if (itemCode && description && !isNaN(unitPrice) && !isNaN(qty)) {
                        tableData.push({
                            product: `${description}\n(${itemCode})`,
                            unit: unit,
                            packageUnit: packageUnit,
                            unitPrice: unitPrice.toFixed(2),
                            qty: qty,
                            amount: amount.toFixed(2),
                            remarks: remarks,
                            imgSrc: imgElement && imgElement.src ? imgElement.src : null
                        });
                        subtotal += amount;

                        if (imgElement && imgElement.src) {
                            const promise = new Promise((resolve) => {
                                const img = new Image();
                                img.crossOrigin = "Anonymous";
                                img.onload = () => {
                                    const canvas = document.createElement('canvas');
                                    canvas.width = img.width;
                                    canvas.height = img.height;
                                    const ctx = canvas.getContext('2d');
                                    ctx.drawImage(img, 0, 0);
                                    resolve(canvas.toDataURL('image/png'));
                                };
                                img.onerror = () => resolve(null);
                                img.src = imgElement.src;
                            });
                            imagePromises.push(promise);
                        } else {
                            imagePromises.push(Promise.resolve(null));
                        }
                    }
                });

                if (tableData.length === 0) {
                    showToast("No valid products to include in PDF.");
                    return;
                }

                const imageDataURLs = await Promise.all(imagePromises);
                tableData.forEach((rowData, index) => {
                    rowData.imgData = imageDataURLs[index];
                });

                const tableRows = tableData.map(rowData => [
                    '', // Placeholder for image column
                    rowData.product,
                    rowData.unit,
                    rowData.packageUnit,
                    rowData.unitPrice,
                    rowData.qty,
                    rowData.amount,
                    rowData.remarks
                ]);

                const headers = ["Image", "Product", "Unit", "Pkg Unit", "Unit Price", "Quantity", "Amount", "Remarks"];
                const pageWidth = 210;
                const margin = 10;
                const availableWidth = pageWidth - 2 * margin;
                const columnWidths = {
                    0: 15,
                    1: 50,
                    2: 20,
                    3: 20,
                    4: 20,
                    5: 20,
                    6: 20,
                    7: 25
                };
                const totalWidth = Object.values(columnWidths).reduce((sum, w) => sum + w, 0);
                if (totalWidth > availableWidth) {
                    const scaleFactor = availableWidth / totalWidth;
                    Object.keys(columnWidths).forEach(key => {
                        columnWidths[key] = Math.floor(columnWidths[key] * scaleFactor);
                    });
                }

                let startY = 68;
                // Use formType in file name
                const fileName = getExportFileName(formType) + '.pdf';
                doc.autoTable({
                    head: [headers],
                    body: tableRows,
                    startY: startY,
                    theme: 'grid',
                    styles: { fontSize: 8, cellPadding: 2, encoding: 'utf8', minCellHeight: 15 },
                    headStyles: { fillColor: [41, 128, 185], textColor: 255 },
                    columnStyles: {
                        0: { cellWidth: columnWidths[0] },
                        1: { cellWidth: columnWidths[1] },
                        2: { cellWidth: columnWidths[2] },
                        3: { cellWidth: columnWidths[3] },
                        4: { cellWidth: columnWidths[4], halign: 'right' },
                        5: { cellWidth: columnWidths[5], halign: 'right' },
                        6: { cellWidth: columnWidths[6], halign: 'right' },
                        7: { cellWidth: columnWidths[7] }
                    },
                    didDrawCell: (data) => {
                        if (data.section === 'body' && data.column.index === 0 && data.row.index < tableData.length) {
                            const imgData = tableData[data.row.index].imgData;
                            if (imgData) {
                                const cellX = data.cell.x + 2;
                                const cellY = data.cell.y + 2;
                                const imgWidth = 10;
                                const imgHeight = 10;
                                try {
                                    doc.addImage(imgData, 'PNG', cellX, cellY, imgWidth, imgHeight);
                                } catch (e) {
                                    console.warn('Failed to add image to PDF:', e);
                                }
                            }
                        }
                    },
                    margin: { left: margin, right: margin },
                    didDrawPage: function (data) {
                        const pageCount = doc.internal.getNumberOfPages();
                        const pageSize = doc.internal.pageSize;
                        const pageWidth = pageSize.getWidth();
                        const pageHeight = pageSize.getHeight();
                        const page = doc.internal.getCurrentPageInfo().pageNumber;
                        // 頁數左下角
                        doc.setFontSize(9);
                        doc.text(`Page ${page} of ${pageCount}`,
                            margin, pageHeight - 8, { align: 'left' });
                        // 檔案名稱右下
                        doc.setFontSize(8);
                        doc.text(fileName, pageWidth - 10, pageHeight - 8, { align: 'right' });
                    }
                });

                let finalY = doc.lastAutoTable.finalY || startY;
                const remarks = getField('remarks');
                if (remarks) {
                    doc.setFontSize(10);
                    doc.text("Remarks:", 10, finalY + 10);
                    doc.text(remarks, 10, finalY + 16);
                    finalY += 20;
                }

                const discount = parseFloat(getField('discount')) || 0;
                const discountAmount = (subtotal * discount / 100).toFixed(2);
                const taxRate = parseFloat(getField('taxRate')) || 0;
                const taxAmount = ((subtotal - discountAmount) * taxRate / 100).toFixed(2);
                const freight = parseFloat(getField('freight')) || 0;
                const depositPct = parseFloat(getField('deposit')) || 0;
                const additionalChargePct = parseFloat(getField('additionalCharge')) || 0;
                const deposit = subtotal * depositPct / 100;
                const additionalCharge = subtotal * additionalChargePct / 100;
                const grandTotal = (subtotal - discountAmount + parseFloat(taxAmount) + freight + deposit + additionalCharge).toFixed(2);

                doc.setFontSize(10);
                doc.text(`Subtotal: HKD ${subtotal.toFixed(2)}`, 150, finalY + 10);
                doc.text(`Discount: HKD ${discountAmount}`, 150, finalY + 16);
                doc.text(`Tax: HKD ${taxAmount}`, 150, finalY + 22);
                doc.text(`Freight: HKD ${freight.toFixed(2)}`, 150, finalY + 28);
                doc.text(`Deposit: HKD ${deposit.toFixed(2)}`, 150, finalY + 34);
                doc.text(`Additional Charge: HKD ${additionalCharge.toFixed(2)}`, 150, finalY + 40);
                doc.text(`Grand Total: HKD ${grandTotal}`, 150, finalY + 46);

                const paymentTerms = getField('paymentTerms');
                if (paymentTerms) {
                    doc.text(`Payment Terms: ${paymentTerms}`, 10, finalY + 54);
                }

                const qrCodeElement = document.querySelector('#qrcode canvas');
                if (qrCodeElement) {
                    doc.addImage(qrCodeElement.toDataURL(), 'PNG', 160, finalY + 60, 30, 30);
                }

                doc.save(fileName);
                showToast("PDF generated successfully!");
                closePDFModal();
            } catch (err) {
                console.error('PDF generation error:', err);
                showToast("Failed to generate PDF: " + err.message);
            }
        }

        function downloadCSV() {
            const headers = ["Line No.", "Item Code", "Description", "Unit", "Package Unit", "Qty", "Unit Price", "Amount", "Remarks"];
            const rows = [];
            document.querySelectorAll("#quotationBody tr").forEach((row, index) => {
                const itemCodeEl = row.querySelector(".item-code");
                const descriptionEl = row.querySelector(".description");
                const unitEl = row.querySelector(".unit");
                const packageUnitEl = row.querySelector(".package-unit");
                const qtyEl = row.querySelector(".qty");
                const unitPriceEl = row.querySelector(".unit-price");
                const amountEl = row.querySelector(".amount");
                const remarksEl = row.querySelector(".remarks");
                const itemCode = itemCodeEl ? itemCodeEl.value : '';
                const description = descriptionEl ? descriptionEl.value : '';
                const unit = unitEl ? unitEl.value : '';
                const packageUnit = packageUnitEl ? packageUnitEl.value : '1';
                const qty = qtyEl ? qtyEl.value : '0';
                const unitPrice = unitPriceEl ? unitPriceEl.value : '0.00';
                const amount = amountEl ? amountEl.value : '0.00';
                const remarks = remarksEl ? remarksEl.value : '';
                rows.push([index + 1, itemCode, description, unit, packageUnit, qty, unitPrice, amount, remarks]);
            });
            let csvContent = headers.join(",") + "\n" + rows.map(row => row.join(",")).join("\n");
            const fileName = getExportFileName('Quotation') + '.csv';
            const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = fileName;
            link.click();
        }

        function exportToExcel() {
            const headers = ["Line No.", "Item Code", "Description", "Unit", "Package Unit", "Qty", "Unit Price", "Amount", "Remarks"];
            const rows = [];
            document.querySelectorAll("#quotationBody tr").forEach((row, index) => {
                const itemCodeEl = row.querySelector(".item-code");
                const descriptionEl = row.querySelector(".description");
                const unitEl = row.querySelector(".unit");
                const packageUnitEl = row.querySelector(".package-unit");
                const qtyEl = row.querySelector(".qty");
                const unitPriceEl = row.querySelector(".unit-price");
                const amountEl = row.querySelector(".amount");
                const remarksEl = row.querySelector(".remarks");
                const itemCode = itemCodeEl ? itemCodeEl.value : '';
                const description = descriptionEl ? descriptionEl.value : '';
                const unit = unitEl ? unitEl.value : '';
                const packageUnit = packageUnitEl ? packageUnitEl.value : '1';
                const qty = qtyEl ? qtyEl.value : '0';
                const unitPrice = unitPriceEl ? unitPriceEl.value : '0.00';
                const amount = amountEl ? amountEl.value : '0.00';
                const remarks = remarksEl ? remarksEl.value : '';
                rows.push([index + 1, itemCode, description, unit, packageUnit, qty, unitPrice, amount, remarks]);
            });
            const worksheet = XLSX.utils.aoa_to_sheet([headers, ...rows]);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "Quotation");
            const fileName = getExportFileName('Quotation') + '.xlsx';
            XLSX.writeFile(workbook, fileName);
        }

        function downloadProductTemplate() {
            const headers = ["itemCode", "descriptionEng", "descriptionChi", "unit", "packageUnit", "unitPrice", "cost"];
            const example = [
                "P12345",
                "Sample Product",
                "样本产品",
                "PCS",
                "10",
                "10.00",
                "8.00"
            ];
            let csvContent = headers.join(",") + "\n" + example.join(",") + "\n";
            const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = "product_template.csv";
            link.click();
        }

        function downloadCustomerTemplate() {
            const headers = [
                "accountNo", "companyName", "firstName", "lastName", "businessPhone", "mobilePhone", "businessEmail", "flat", "building", "street", "district", "city", "zipCode"
            ];
            const example = [
                "A00001", "Sample Company", "John", "Doe", "12345678", "91234567", "john.doe@email.com", "Room 101, 10/F", "Sunshine Tower", "123 Sample St", "Kwun Tong", "Kowloon", "HKG"
            ];
            let csvContent = headers.join(",") + "\n" + example.join(",") + "\n";
            const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = "customer_template.csv";
            link.click();
        }

        function downloadQuickRowTemplate() {
            const headers = ["itemCode","qty","unitPrice"];
            const example = ["P12345","2","10.00"];
            let csvContent = headers.join(",") + "\n" + example.join(",") + "\n";
            const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = "quick_upload_template.csv";
            link.click();
        }

        function getExportFileName(type) {
            // Use formType if available
            const formType = document.getElementById('formType')?.value || type || 'Quotation';
            const quotationNo = document.getElementById('quotationNo').value || 'Q';
            const companyName = (document.getElementById('companyName').value || 'Company').replace(/[^a-zA-Z0-9]/g, '');
            const accountNo = (document.getElementById('accountNo').value || 'A').replace(/[^a-zA-Z0-9]/g, '');
            const date = (document.getElementById('quotationDate').value || new Date().toISOString().slice(0,10)).replace(/-/g, '');
            return `${formType}_${quotationNo}_${companyName}_${accountNo}_${date}`;
        }

        function getDraftData() {
            const formFields = ['accountNo', 'quotationNo', 'companyName', 'firstName', 'lastName', 'mobilePhone', 'businessPhone', 'businessEmail', 'quotationDate', 'paymentTerms', 'deliveryTerms', 'validUntil', 'address', 'remarks', 'taxRate', 'discount', 'salesrepPhone', 'salesrepEmail', 'freight', 'salesRep', 'deposit', 'additionalCharge'];
            const form = {};
            formFields.forEach(id => {
                const el = document.getElementById(id);
                form[id] = el ? el.value : '';
            });
            const rows = [];
            document.querySelectorAll("#quotationBody tr").forEach(row => {
                rows.push({
                    itemCode: row.querySelector('.item-code').value || '',
                    description: row.querySelector('.description').value || '',
                    unit: row.querySelector('.unit').value || '',
                    packageUnit: row.querySelector('.package-unit') ? row.querySelector('.package-unit').value : '1',
                    qty: row.querySelector('.qty').value || '',
                    unitPrice: row.querySelector('.unit-price').value || '',
                    amount: row.querySelector('.amount').value || '',
                    lineRemark: row.querySelector('.remarks').value || ''
                });
            });
            return { form, rows };
        }

        function setDraftData(data) {
            if (!data) return;
            Object.entries(data.form).forEach(([id, val]) => {
                const el = document.getElementById(id);
                if (el) el.value = val;
            });
            document.getElementById('quotationBody').innerHTML = '';
            rowCounter = 1;
            data.rows.forEach(row => {
                addRowFromCSV({
                    itemCode: row.itemCode,
                    qty: parseFloat(row.qty) || 1,
                    unitPrice: parseFloat(row.unitPrice) || 0
                });
                const tr = document.querySelector('#quotationBody tr:last-child');
                tr.querySelector('.remarks').value = row.lineRemark;
            });
            updateTotals();
        }

        function saveDraft() {
            if (!validateAllFields()) {
                showToast('Please fill all required fields correctly.');
                return;
            }
            localStorage.setItem('quotationDraft', JSON.stringify(getDraftData()));
            showToast(LANGS[lang].saved);
        }

        function restoreDraft() {
            const data = localStorage.getItem('quotationDraft');
            if (data) {
                setDraftData(JSON.parse(data));
                showToast(LANGS[lang].restore);
            }
        }

        function populateForm() {
            document.getElementById('accountNo').value = predefinedCustomer.accountNo;
            document.getElementById('quotationNo').value = predefinedCustomer.quotationNo;
            document.getElementById('companyName').value = predefinedCustomer.companyName;
            document.getElementById('firstName').value = predefinedCustomer.firstName || '';
            document.getElementById('lastName').value = predefinedCustomer.lastName || '';
            document.getElementById('mobilePhone').value = predefinedCustomer.mobilePhone || '';
            document.getElementById('businessPhone').value = predefinedCustomer.businessPhone || '';
            document.getElementById('businessEmail').value = predefinedCustomer.businessEmail || '';
            document.getElementById('quotationDate').value = predefinedCustomer.quotationDate;
            document.getElementById('validUntil').value = predefinedCustomer.validUntil;
            document.getElementById('address').value = predefinedCustomer.address;
            document.getElementById('salesRep').value = predefinedCustomer.salesRep;
            document.getElementById('customerType').value = predefinedCustomer.customerType;

            productDatabase = predefinedProducts;
            document.getElementById('quotationBody').innerHTML = '';
            rowCounter = 1;
            
            addRowFromCSV({
                itemCode: "6344598",
                qty: 1,
                unitPrice: predefinedProducts.find(p => p.itemCode === "6344598").unitPrice
            });
            updateTotals();
        }

        function showToast(msg) {
            let toast = document.getElementById('toastMsg');
            if (!toast) {
                toast = document.createElement('div');
                toast.id = 'toastMsg';
                document.body.appendChild(toast);
            }
            toast.textContent = msg;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        function openPDFModal() {
            document.getElementById('pdfModal').classList.add('show');
        }

        function closePDFModal() {
            document.getElementById('pdfModal').classList.remove('show');
        }

        function suggestTerms(customerType, language, amount) {
            const termsTemplates = {
                en: {
                    standard: "This quotation is valid for 30 days. ",
                    corporate: "Corporate clients enjoy a 5% discount for orders above $10,000.",
                    government: "Government orders are tax-exempt. "
                },
                zh: {
                    standard: "此报价单有效期为30天。",
                    corporate: "企业客户订单满10,000元享95折优惠。",
                    government: "政府订单免税。"
                }
            };
            const key = customerType === 'government' ? 'government' : amount > 10000 ? 'corporate' : 'standard';
            return termsTemplates[language][key];
        }

        function applySuggestedTerms() {
            const customerType = document.getElementById('customerType').value;
            const amount = parseFloat(document.getElementById('grandTotal').textContent) || 0;
            document.getElementById('remarks').value = suggestTerms(customerType, lang, amount);
        }

        document.getElementById('qrLink').addEventListener('input', function() {
            const qrCodeDiv = document.getElementById('qrcode');
            qrCodeDiv.innerHTML = '';
            if (this.value) {
                new QRCode(qrCodeDiv, { text: this.value, width: 100, height: 100 });
            }
        });

        async function autoLoadCSVsIfExist() {
            let loaded = false;
            try {
                const productResp = await fetch('./product.csv');
                if (productResp.ok) {
                    const text = await productResp.text();
                    productDatabase = parseCSV(text);
                    localStorage.setItem('productCsvUploaded', '1');
                    loaded = true;
                }
            } catch(e) {}
            try {
                const customerResp = await fetch('./customer.csv');
                if (customerResp.ok) {
                    const text = await customerResp.text();
                    customerDatabase = parseCustomerCSV(text);
                    loaded = true;
                }
            } catch(e) {}
            if (loaded) {
                document.getElementById('firstTimeModal').classList.remove('show');
                document.body.classList.remove('modal-open');
                document.getElementById('formOverlay').style.display = 'none';
            }
            return loaded;
        }

        document.addEventListener('DOMContentLoaded', async () => {
            document.getElementById('langToggle').addEventListener('click', toggleLang);
            document.getElementById('downloadProductTemplate').addEventListener('click', downloadProductTemplate);
            document.getElementById('downloadCustomerTemplate').addEventListener('click', downloadCustomerTemplate);
            document.getElementById('csvPreviewCancelBtn').addEventListener('click', closeCSVPreviewModal);
            document.getElementById('csvPreviewApplyBtn').addEventListener('click', applyCSVPreview);
            // Add quick upload template button
            const quickBtn = document.createElement('button');
            quickBtn.id = 'downloadQuickRowTemplate';
            quickBtn.className = 'btn btn-primary';
            quickBtn.textContent = 'Quick Row Template';
            quickBtn.onclick = downloadQuickRowTemplate;
            document.querySelector('.toolbar').insertBefore(quickBtn, document.getElementById('downloadProductTemplate'));
            // Add Export CMC CSV button
            const cmcBtn = document.createElement('button');
            cmcBtn.id = 'exportCmcCsvBtn';
            cmcBtn.className = 'btn btn-primary';
            cmcBtn.textContent = 'Export CMC CSV';
            cmcBtn.onclick = exportCmcCsv;
            document.querySelector('.toolbar').insertBefore(cmcBtn, document.getElementById('downloadProductTemplate'));
            // 新增 Quick Entry Bulk Row 按鈕
            const quickEntryBtn = document.createElement('button');
            quickEntryBtn.id = 'quickEntryBulkRowBtn';
            quickEntryBtn.className = 'btn btn-primary';
            quickEntryBtn.textContent = lang === 'en' ? 'Quick Entry Bulk Row' : '快速批量輸入';
            quickEntryBtn.onclick = openQuickEntryModal;
            document.querySelector('.toolbar').insertBefore(quickEntryBtn, document.getElementById('downloadProductTemplate'));
            // QR code default value
            document.getElementById('qrLink').value = 'https://lyrecohk-charleschan.github.io/paymentmethod/';
            document.getElementById('qrLink').dispatchEvent(new Event('input'));
            // Product CSV upload check
            if (!localStorage.getItem('productCsvUploaded')) {
                setTimeout(() => {
                    alert('Please upload Product CSV first.\n請先上傳產品CSV。\n\nFill in Sales Representative, Phone, Email before editing.');
                }, 500);
            }
            // Mark product CSV upload
            document.getElementById('csvFile').addEventListener('change', () => {
                localStorage.setItem('productCsvUploaded', '1');
            });
            populateForm();
            setLang('en');
            // 新增 Restore Draft 按鈕
            if (localStorage.getItem('quotationDraft')) {
                const restoreBtn = document.createElement('button');
                restoreBtn.id = 'restoreDraftBtn';
                restoreBtn.className = 'btn btn-primary';
                restoreBtn.textContent = 'Restore Draft';
                restoreBtn.onclick = restoreDraft;
                // 新增 Clean Draft 按鈕
                const cleanBtn = document.createElement('button');
                cleanBtn.id = 'cleanDraftBtn';
                cleanBtn.className = 'btn btn-danger';
                cleanBtn.textContent = 'Clean Draft';
                cleanBtn.onclick = cleanDraft;
                document.querySelector('.toolbar').appendChild(cleanBtn);
            }
            // quotationNo 自動產生
            document.getElementById('quotationNo').value = generateQuotationNo();
            // quotationDate 預設今天
            const today = new Date();
            document.getElementById('quotationDate').value = today.toISOString().slice(0, 10);
            // validUntil 預設今天+30天
            const validUntil = new Date(today.getTime() + 30 * 24 * 60 * 60 * 1000);
            document.getElementById('validUntil').value = validUntil.toISOString().slice(0, 10);

            let loaded = await autoLoadCSVsIfExist();
            // 停用自動彈出 firstTimeModal
            // if (!loaded && !localStorage.getItem('productCsvUploaded')) {
            //     showFirstTimeModal();
            // } else {
            document.getElementById('firstTimeModal').classList.remove('show');
            document.body.classList.remove('modal-open');
            document.getElementById('formOverlay').style.display = 'none';
            // }
            document.getElementById('formType').addEventListener('change', updateQuotationNoAndLabel);
            updateQuotationNoAndLabel();
            // Customer Data Management Modal 綁定
            var mgmtCsv = document.getElementById('customerMgmtCsvFile');
            if (mgmtCsv) mgmtCsv.onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = function(evt) {
                    customerDatabase = parseCustomerCSV(evt.target.result);
                    renderCustomerMgmtTable();
                    showToast('CSV loaded: ' + customerDatabase.length + ' rows');
                };
                reader.readAsText(file);
            };
            var mgmtJson = document.getElementById('customerMgmtJsonFile');
            if (mgmtJson) {
                mgmtJson.onchange = function(e) {
                    const file = e.target.files[0];
                    if (!file) return;
                    const reader = new FileReader();
                    reader.onload = function(evt) {
                        try {
                            customerDatabase = JSON.parse(evt.target.result);
                            renderCustomerMgmtTable();
                            showToast('JSON loaded: ' + customerDatabase.length + ' rows');
                        } catch(err) { showToast('Invalid JSON'); }
                    };
                    reader.readAsText(file);
                };
            }
            var mgmtExportBtn = document.getElementById('customerMgmtExportCsvBtn');
            if (mgmtExportBtn) mgmtExportBtn.onclick = function() {
                if (!Array.isArray(customerDatabase) || customerDatabase.length === 0) {
                    showToast('No data to export'); return;
                }
                const keys = Object.keys(customerDatabase[0]);
                let csv = keys.join(',') + '\n';
                customerDatabase.forEach(row => {
                    csv += keys.map(k => '"'+String(row[k]||'').replace(/"/g,'""')+'"').join(',') + '\n';
                });
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = 'customer_export.csv';
                link.click();
            };
            // Modal 關閉 UX
            const mgmtModal = document.getElementById('customerDataMgmtModal');
            if (mgmtModal) {
                mgmtModal.addEventListener('mousedown', function(e) {
                    if (e.target === mgmtModal) closeCustomerMgmtModal();
                });
            }
        });

        // First time modal logic
        function showFirstTimeModal() {
            document.getElementById('firstTimeModal').classList.add('show');
        }

        function checkFirstTimeFormValidity() {
            const fileInput = document.getElementById('firstTimeProductCsv');
            const salesRep = document.getElementById('salesRep').value.trim();
            const phone = document.getElementById('salesrepPhone').value.trim();
            const email = document.getElementById('salesrepEmail').value.trim();
            const submitBtn = document.getElementById('firstTimeSubmitBtn');
            if (fileInput.files.length === 0 || !salesRep || !phone || !email) {
                submitBtn.disabled = true;
            } else {
                submitBtn.disabled = false;
            }
        }

        function hideFirstTimeModal() {
            document.getElementById('firstTimeModal').classList.remove('show');
            document.body.classList.remove('modal-open');
            document.getElementById('formOverlay').style.display = 'none';
        }

        function clearAllLocalStorage() {
            localStorage.clear();
        }

        function handleFirstTimeSubmit() {
            alert('submit!');
            const fileInput = document.getElementById('firstTimeProductCsv');
            const salesRep = document.getElementById('salesRep').value.trim();
            const phone = document.getElementById('salesrepPhone').value.trim();
            const email = document.getElementById('salesrepEmail').value.trim();
            const errorDiv = document.getElementById('firstTimeError');
            errorDiv.textContent = '';
            if (!fileInput.files[0]) {
                errorDiv.textContent = 'Please upload Product CSV.';
                return;
            }
            if (!salesRep) {
                errorDiv.textContent = 'Please enter Sales Representative.';
                return;
            }
            if (!phone) {
                errorDiv.textContent = 'Please enter Phone.';
                return;
            }
            if (!email) {
                errorDiv.textContent = 'Please enter Email.';
                return;
            }
            // Parse and load product CSV
            const reader = new FileReader();
            reader.onload = function(e) {
                productDatabase = parseCSV(e.target.result);
                localStorage.setItem('productCsvUploaded', '1');
                // 只在 salesRep input 有值時才覆蓋
                if (salesRep) document.getElementById('salesRep').value = salesRep;
                if (phone) document.getElementById('salesrepPhone').value = phone;
                if (email) document.getElementById('salesrepEmail').value = email;
                document.getElementById('quotationBody').innerHTML = '';
                rowCounter = 1;
                addRow();
                hideFirstTimeModal();
                if (localStorage.getItem('quotationDraft')) restoreDraft();
            };
            reader.readAsText(fileInput.files[0]);
        }
        document.addEventListener('DOMContentLoaded', () => {
            // First time modal logic
            if (!localStorage.getItem('productCsvUploaded')) {
                showFirstTimeModal();
            } else {
                document.getElementById('firstTimeModal').classList.remove('show');
                // 只保留手動 restoreDraft，不自動 restore
            }
            document.getElementById('firstTimeSubmitBtn').onclick = handleFirstTimeSubmit;
            document.getElementById('firstTimeDownloadProductTemplate').onclick = downloadProductTemplate;
            // 新增即時檢查
            document.getElementById('firstTimeProductCsv').addEventListener('change', checkFirstTimeFormValidity);
            document.getElementById('salesRep').addEventListener('input', checkFirstTimeFormValidity);
            document.getElementById('salesrepPhone').addEventListener('input', checkFirstTimeFormValidity);
            document.getElementById('salesrepEmail').addEventListener('input', checkFirstTimeFormValidity);
        });

        // Internal info modal
        function showInternalInfo(btn) {
            const row = btn.closest('tr');
            const itemCodeInput = row.querySelector('.item-code');
            const qtyInput = row.querySelector('.qty');
            const packageUnitInput = row.querySelector('.package-unit');
            const unitPriceInput = row.querySelector('.unit-price');
            if (!itemCodeInput || !qtyInput || !unitPriceInput) {
                alert('Row data is incomplete.');
                return;
            }
            const itemCode = itemCodeInput.value || '';
            const qty = parseFloat(qtyInput.value) || 0;
            const packageUnit = packageUnitInput ? parseFloat(packageUnitInput.value) : 1;
            const unitPrice = parseFloat(unitPriceInput.value) || 0;
            const product = productDatabase.find(p => p.itemCode === itemCode) || {};
            const cost = parseFloat(product.cost) || 0;
            const amount = qty * packageUnit * unitPrice;
            const totalCost = cost * qty * packageUnit;
            const cashMargin = amount - totalCost;
            const marginPct = amount > 0 ? (cashMargin / amount * 100) : 0;
            let nameCM = String(Math.floor(marginPct / 5));
            if (nameCM.length === 1) nameCM = '0' + nameCM;
            let cmExplain = '';
            if (!isNaN(marginPct)) {
                const cmBand = Math.floor(marginPct / 5);
                const cmLow = (cmBand * 5).toFixed(1);
                const cmHigh = ((cmBand + 1) * 5).toFixed(1);
                cmExplain = `(${cmLow}% - ${cmHigh}%)`;
            }
            let modal = document.getElementById('internalInfoModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'internalInfoModal';
                modal.className = 'modal show';
                modal.innerHTML = `
                    <div class="modal-content">
                        <h2 class="text-lg font-semibold mb-4">Internal Info</h2>
                        <div class="space-y-2">
                            <div>Cost: <span id="internalCost"></span></div>
                            <div>Cash Margin: <span id="internalCashMargin"></span></div>
                            <div>Margin %: <span id="internalMarginPct"></span></div>
                            <div>CM: <span id="internalNameCM"></span> <span id="internalCMExplain" style="color:#888;font-size:0.9em;"></span></div>
                        </div>
                        <div class="flex justify-end gap-2 mt-4">
                            <button class="btn btn-danger" onclick="closeInternalInfoModal()">Close</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            } else {
                modal.classList.add('show');
            }
            document.getElementById('internalCost').textContent = cost.toFixed(2);
            document.getElementById('internalCashMargin').textContent = cashMargin.toFixed(2);
            document.getElementById('internalMarginPct').textContent = marginPct.toFixed(1) + '%';
            document.getElementById('internalNameCM').textContent = nameCM;
            document.getElementById('internalCMExplain').textContent = cmExplain;
        }

        function closeInternalInfoModal() {
            const modal = document.getElementById('internalInfoModal');
            if (modal) modal.classList.remove('show');
        }

        function exportCmcCsv() {
            const headers = ["itemCode", "unitPrice"];
            const rows = [];
            document.querySelectorAll("#quotationBody tr").forEach(row => {
                const itemCode = row.querySelector(".item-code").value || '';
                const unitPrice = row.querySelector(".unit-price").value || '';
                if (itemCode) rows.push([itemCode, unitPrice]);
            });
            let csvContent = headers.join(",") + "\n" + rows.map(row => row.join(",")).join("\n");
            const fileName = getExportFileName('CMC') + '.csv';
            const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = fileName;
            link.click();
        }

        // Quick Entry Bulk Row Modal
        (function addQuickEntryModal() {
            if (document.getElementById('quickEntryModal')) return;
            const modal = document.createElement('div');
            modal.id = 'quickEntryModal';
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content">
                    <h2 class="text-lg font-semibold mb-4">${lang === 'en' ? 'Quick Entry Bulk Row' : '快速批量輸入'}</h2>
                    <div class="mb-4 text-sm text-gray-600">${lang === 'en' ? 'Paste multiple lines, each line: itemCode,qty or itemCode,qty,unitPrice' : '每行輸入：itemCode,數量 或 itemCode,數量,單價'}</div>
                    <textarea id="quickEntryTextarea" class="form-input" rows="8" style="width:100%;"></textarea>
                    <div id="quickEntryError" class="text-red-600 text-sm mt-2"></div>
                    <div class="flex justify-end gap-2 mt-4">
                        <button class="btn btn-danger" onclick="closeQuickEntryModal()">${lang === 'en' ? 'Cancel' : '取消'}</button>
                        <button class="btn btn-success" onclick="applyQuickEntryRows()">${lang === 'en' ? 'Apply' : '應用'}</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        })();

        function openQuickEntryModal() {
            document.getElementById('quickEntryTextarea').value = '';
            document.getElementById('quickEntryError').textContent = '';
            document.getElementById('quickEntryModal').classList.add('show');
        }
        function closeQuickEntryModal() {
            document.getElementById('quickEntryModal').classList.remove('show');
        }
        function applyQuickEntryRows() {
            const val = document.getElementById('quickEntryTextarea').value.trim();
            const errorDiv = document.getElementById('quickEntryError');
            errorDiv.textContent = '';
            if (!val) {
                errorDiv.textContent = lang === 'en' ? 'Please enter at least one line.' : '請輸入至少一行資料。';
                return;
            }
            const lines = val.split(/\r?\n/).map(l => l.trim()).filter(Boolean);
            let added = 0, failed = 0;
            lines.forEach(line => {
                // 支援逗號、空格、tab 任意一種分隔
                let parts = line.split(/[\,\s\t]+/).map(x => x.trim()).filter(Boolean);
                if (parts.length < 2) { failed++; return; }
                const itemCode = parts[0];
                const qty = parseFloat(parts[1]);
                let unitPrice = undefined;
                if (parts.length >= 3) {
                    unitPrice = parseFloat(parts[2]);
                    if (isNaN(unitPrice)) unitPrice = undefined;
                }
                if (!itemCode || isNaN(qty) || qty < 1) { failed++; return; }
                if (unitPrice !== undefined) {
                    addRowFromCSV({ itemCode, qty, unitPrice });
                } else {
                    addRowFromCSV({ itemCode, qty });
                }
                added++;
            });
            updateTotals();
            closeQuickEntryModal();
            showToast(`${added} ${lang === 'en' ? 'rows added.' : '行已加入。'}${failed ? ' ' + failed + (lang === 'en' ? ' failed.' : '行失敗。') : ''}`);
        }

        // Clean Draft function
        function cleanDraft() {
            localStorage.removeItem('quotationDraft');
            showToast('Draft cleaned!');
            // Optionally, reload to update UI
            setTimeout(() => location.reload(), 800);
        }

        function updateDepositAmount() {
            const subtotal = parseFloat(document.getElementById('subtotal').textContent) || 0;
            const depositPct = parseFloat(document.getElementById('deposit').value) || 0;
            const amount = subtotal * depositPct / 100;
            document.getElementById('depositAmountLabel').textContent = `= ${amount.toFixed(2)}`;
        }

        function updateAdditionalChargeAmount() {
            const subtotal = parseFloat(document.getElementById('subtotal').textContent) || 0;
            const addPct = parseFloat(document.getElementById('additionalCharge').value) || 0;
            const amount = subtotal * addPct / 100;
            document.getElementById('additionalChargeAmountLabel').textContent = `= ${amount.toFixed(2)}`;
        }

        document.getElementById('firstTimeSetupBtn').onclick = function() {
            document.getElementById('firstTimeModal').classList.add('show');
            document.body.classList.add('modal-open');
            document.getElementById('formOverlay').style.display = 'block';
            checkFirstTimeFormValidity();
        };

        document.addEventListener('click', function(e) {
            const btn = e.target.closest('#firstTimeSubmitBtn');
            if (btn) {
                handleFirstTimeSubmit();
            }
        });

        // 隱藏 First Setup 按鈕
        const firstSetupBtn = document.getElementById('firstTimeSetupBtn');
        if (firstSetupBtn) firstSetupBtn.style.display = 'none';
        // 停用 firstTimeModal
        const firstTimeModal = document.getElementById('firstTimeModal');
        if (firstTimeModal) firstTimeModal.style.display = 'none';

        // Calculator Modal Logic
        (function setupCalculatorModal() {
            const ids = ['calcCost','calcSP','calcMargin','calcMarkup','calcCashMargin','calcNameCMInput'];
            ids.forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    el.addEventListener('input', calculatorAutoUpdate);
                }
            });
            function to2(val) {
                return isFinite(val) ? parseFloat(val).toFixed(2) : '';
            }
            function calculatorAutoUpdate(e) {
                let cost = parseFloat(document.getElementById('calcCost')?.value) || 0;
                let sp = parseFloat(document.getElementById('calcSP')?.value) || 0;
                let margin = parseFloat(document.getElementById('calcMargin')?.value) || 0;
                let markup = parseFloat(document.getElementById('calcMarkup')?.value) || 0;
                let cashMargin = parseFloat(document.getElementById('calcCashMargin')?.value) || 0;
                let nameCM = document.getElementById('calcNameCMInput')?.value;
                let changed = e?.target?.id;

                // NameCM 處理
                if (changed === 'calcNameCMInput') {
                    let n = parseInt(nameCM, 10);
                    if (isNaN(n) || n < 0) n = 0;
                    if (n > 19) n = 19;
                    nameCM = n;
                    margin = n * 5;
                    sp = cost / (1 - margin / 100);
                    cashMargin = sp - cost;
                    markup = cost ? (cashMargin / cost * 100) : 0;
                } else if (changed === 'calcCost') {
                    if (margin) {
                        sp = cost / (1 - margin / 100);
                        cashMargin = sp - cost;
                        markup = cost ? (cashMargin / cost * 100) : 0;
                    } else if (markup) {
                        sp = cost * (1 + markup / 100);
                        cashMargin = sp - cost;
                        margin = sp ? (cashMargin / sp * 100) : 0;
                    } else if (cashMargin) {
                        sp = cost + cashMargin;
                        margin = sp ? (cashMargin / sp * 100) : 0;
                        markup = cost ? (cashMargin / cost * 100) : 0;
                    } else {
                        sp = 0; margin = 0; markup = 0; cashMargin = 0;
                    }
                    nameCM = Math.floor(margin / 5);
                } else if (changed === 'calcSP') {
                    cashMargin = sp - cost;
                    margin = sp ? (cashMargin / sp * 100) : 0;
                    markup = cost ? (cashMargin / cost * 100) : 0;
                    nameCM = Math.floor(margin / 5);
                } else if (changed === 'calcMargin') {
                    sp = cost / (1 - margin / 100);
                    cashMargin = sp - cost;
                    markup = cost ? (cashMargin / cost * 100) : 0;
                    nameCM = Math.floor(margin / 5);
                } else if (changed === 'calcMarkup') {
                    sp = cost * (1 + markup / 100);
                    cashMargin = sp - cost;
                    margin = sp ? (cashMargin / sp * 100) : 0;
                    nameCM = Math.floor(margin / 5);
                } else if (changed === 'calcCashMargin') {
                    sp = cost + cashMargin;
                    margin = sp ? (cashMargin / sp * 100) : 0;
                    markup = cost ? (cashMargin / cost * 100) : 0;
                    nameCM = Math.floor(margin / 5);
                }
                // 格式化
                document.getElementById('calcCost').value = cost !== undefined ? to2(cost) : '';
                document.getElementById('calcSP').value = sp !== undefined ? to2(sp) : '';
                document.getElementById('calcMargin').value = margin !== undefined ? to2(margin) : '';
                document.getElementById('calcMarkup').value = markup !== undefined ? to2(markup) : '';
                document.getElementById('calcCashMargin').value = cashMargin !== undefined ? to2(cashMargin) : '';
                document.getElementById('calcNameCM').textContent = nameCM < 10 ? '0' + nameCM : nameCM;
                document.getElementById('calcNameCMInput').value = nameCM;
                // NameCM 區間說明
                let explain = '';
                if (!isNaN(nameCM)) {
                    let low = nameCM * 5, high = (parseInt(nameCM) + 1) * 5;
                    explain = `對應 Margin 區間：${low}% ~ ${high}%`;
                }
                var nameCMExplain = document.getElementById('nameCMExplain');
                if (nameCMExplain) nameCMExplain.textContent = explain;
                // Summary
                document.getElementById('calcResultSummary').innerHTML =
                    `Margin: <b>${margin ? to2(margin) : ''}%</b> &nbsp;|&nbsp; nameCM: <b>${nameCM < 10 ? '0' + nameCM : nameCM}</b>`;
                // Real-time result area
                document.getElementById('resultSP').textContent = to2(sp);
                document.getElementById('resultMargin').textContent = to2(margin) + '%';
                document.getElementById('resultMarkup').textContent = to2(markup) + '%';
                document.getElementById('resultCashMargin').textContent = to2(cashMargin);
                document.getElementById('resultNameCM').textContent = nameCM < 10 ? '0' + nameCM : nameCM;
                document.getElementById('resultMarginRange').textContent = explain;

                // Calculate price by margin %
                let priceByMargin = '';
                if (cost && margin) {
                    priceByMargin = cost / (1 - margin / 100);
                }
                document.getElementById('calcPriceByMargin').value = priceByMargin ? to2(priceByMargin) : '';

                // Calculate price by markup %
                let priceByMarkup = '';
                if (cost && markup) {
                    priceByMarkup = cost * (1 + markup / 100);
                }
                document.getElementById('calcPriceByMarkup').value = priceByMarkup ? to2(priceByMarkup) : '';
            }
            window.copyCalcValue = function(id) {
                const el = document.getElementById(id);
                if (el) {
                    el.select();
                    document.execCommand('copy');
                }
            };
            window.cleanCalculatorModal = function() {
                ['calcCost','calcSP','calcMargin','calcMarkup','calcCashMargin','calcNameCMInput','calcPriceByMargin','calcPriceByMarkup'].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.value = '';
                });
                document.getElementById('calcResultSummary').innerHTML = '';
                document.getElementById('calcResultDetail').innerHTML = '';
                document.getElementById('calcNameCM').textContent = '';
                document.getElementById('nameCMExplain').textContent = '';
                document.getElementById('resultSP').textContent = '';
                document.getElementById('resultMargin').textContent = '';
                document.getElementById('resultMarkup').textContent = '';
                document.getElementById('resultCashMargin').textContent = '';
                document.getElementById('resultNameCM').textContent = '';
                document.getElementById('resultMarginRange').textContent = '';
            };
        })();

        // Calculator Modal 開關
        (function setupCalculatorToolbarBtn() {
            var btn = document.getElementById('openCalculatorBtn');
            if (btn) {
                btn.onclick = function() {
                    document.getElementById('calculatorModal').classList.add('show');
                };
            }
            // 關閉 calculatorModal 時移除 show class
            window.closeCalculatorModal = function() {
                document.getElementById('calculatorModal').classList.remove('show');
            };
        })();
        var calcNameCMInput = document.getElementById('calcNameCMInput');
        if (calcNameCMInput) {
            calcNameCMInput.addEventListener('input', function() {
                let nameCM = parseInt(this.value, 10);
                let explain = '';
                if (!isNaN(nameCM)) {
                    let low = nameCM * 5, high = (nameCM + 1) * 5;
                    explain = `對應 Margin 區間：${low}% ~ ${high}%`;
                }
                var nameCMExplain = document.getElementById('nameCMExplain');
                if (nameCMExplain) nameCMExplain.textContent = explain;
            });
        }
        document.getElementById('calcNameCMInput').addEventListener('input', function() {
            let nameCM = parseInt(this.value, 10);
            let explain = '';
            if (!isNaN(nameCM)) {
                if (nameCM < 0) nameCM = 0;
                if (nameCM > 19) nameCM = 19;
                let low = nameCM * 5, high = (nameCM + 1) * 5;
                explain = `對應 Margin 區間：${low}% ~ ${high}%`;
            }
            document.getElementById('nameCMExplain').textContent = explain;
        });

        // 欄位驗證工具
        function validateField(id, type = 'required') {
            const el = document.getElementById(id);
            if (!el) return true;
            let valid = true;
            let msg = '';
            const val = el.value.trim();
            if (type === 'required' && !val) {
                valid = false;
                msg = 'Required';
            } else if (type === 'phone' && val && !/^\d{6,}$/.test(val.replace(/\D/g, ''))) {
                valid = false;
                msg = 'Invalid phone';
            } else if (type === 'email' && val && !/^\S+@\S+\.\S+$/.test(val)) {
                valid = false;
                msg = 'Invalid email';
            } else if (type === 'zip' && val && !['000','0000','000000','HKG'].includes(val)) {
                valid = false;
                msg = 'Invalid zip';
            }
            let err = el.parentElement.querySelector('.field-error');
            if (!valid) {
                if (!err) {
                    err = document.createElement('div');
                    err.className = 'field-error text-xs text-red-600 mt-1';
                    el.parentElement.appendChild(err);
                }
                err.textContent = msg;
                el.classList.add('border-red-500');
            } else {
                if (err) err.remove();
                el.classList.remove('border-red-500');
            }
            return valid;
        }

        // 綁定即時驗證
        ['accountNo','companyName','firstName','lastName','businessPhone','address','mobilePhone','businessEmail'].forEach(function(id) {
            var el = document.getElementById(id);
            if (el) {
                el.addEventListener('input', function() {
                    if (id === 'businessPhone' || id === 'mobilePhone') validateField(id, 'phone');
                    else if (id === 'businessEmail') validateField(id, 'email');
                    else validateField(id, 'required');
                });
            }
        });
        // zipCode 處理（如有分拆欄位）
        var zipEl = document.getElementById('zipCode');
        if (zipEl) {
            zipEl.addEventListener('input', function() { validateField('zipCode', 'zip'); });
        }

        // 儲存/送出時驗證所有欄位
        function validateAllFields() {
            var valid = true;
            valid = validateField('accountNo') && valid;
            valid = validateField('companyName') && valid;
            valid = validateField('firstName') && valid;
            valid = validateField('lastName') && valid;
            valid = validateField('businessPhone', 'phone') && valid;
            valid = validateField('address') && valid;
            if (document.getElementById('mobilePhone')) valid = validateField('mobilePhone', 'phone') && valid;
            if (document.getElementById('businessEmail')) valid = validateField('businessEmail', 'email') && valid;
            if (zipEl) valid = validateField('zipCode', 'zip') && valid;
            return !!valid;
        }

        // 儲存/送出前加驗證
        var oldSaveDraft = saveDraft;
        saveDraft = function() {
            if (!validateAllFields()) {
                showToast('Please fill all required fields correctly.');
                return;
            }
            oldSaveDraft();
        };

        // PDF 產生前加驗證
        var oldConfirmGeneratePDF = confirmGeneratePDF;
        confirmGeneratePDF = async function() {
            if (!validateAllFields()) {
                showToast('Please fill all required fields correctly.');
                closePDFModal();
                return;
            }
            await oldConfirmGeneratePDF();
        };

        // 必填欄位 label 加紅色星號
        ['accountNo','companyName','firstName','lastName','businessPhone','address'].forEach(function(id) {
            var label = document.querySelector('label[for="'+id+'"]');
            if (label && !label.innerHTML.includes('text-red-500')) {
                label.innerHTML = label.innerHTML.replace(/(<\/label>)/, ' <span class="text-red-500">*</span>$1');
            }
        });

        // Address 自動分行（每55字元）
        (function setupAddressAutoWrap() {
            var addressEl = document.getElementById('address');
            if (!addressEl) return;
            addressEl.addEventListener('input', function(e) {
                var val = addressEl.value.replace(/\r?\n/g, '');
                var lines = [];
                for (let i = 0; i < val.length; i += 55) {
                    lines.push(val.slice(i, i + 55));
                }
                var joined = lines.join('\n');
                if (addressEl.value !== joined) {
                    addressEl.value = joined;
                }
            });
        })();

        document.getElementById('dataSourceType').addEventListener('change', function() {
            var v = this.value;
            document.getElementById('csvUploadLabel').style.display = v === 'csv' ? 'block' : 'none';
            document.getElementById('jsonUploadLabel').style.display = v === 'json' ? 'block' : 'none';
            document.getElementById('apiInputLabel').style.display = v === 'api' ? 'block' : 'none';
        });
        // JSON 檔案上傳
        var jsonFileInput = document.getElementById('customerJsonFile');
        if (jsonFileInput) {
            jsonFileInput.addEventListener('change', function(e) {
                var file = e.target.files[0];
                if (!file) return;
                var reader = new FileReader();
                reader.onload = function(evt) {
                    try {
                        customerDatabase = JSON.parse(evt.target.result);
                        showToast('Customer JSON loaded: ' + customerDatabase.length + ' entries');
                    } catch (err) {
                        showToast('Invalid JSON file');
                    }
                };
                reader.readAsText(file);
            });
        }
        // API 載入
        var apiBtn = document.getElementById('loadCustomerApiBtn');
        if (apiBtn) {
            apiBtn.addEventListener('click', async function() {
                var url = document.getElementById('customerApiUrl').value.trim();
                if (!url) { showToast('Please enter API URL'); return; }
                try {
                    let resp = await fetch(url);
                    if (!resp.ok) throw new Error('API error');
                    customerDatabase = await resp.json();
                    showToast('Customer API loaded: ' + customerDatabase.length + ' entries');
                } catch (err) {
                    showToast('API load failed');
                }
            });
        }

        // 資料來源切換優化
        (function setupCustomerDataSourceSwitch() {
            const dataSourceType = document.getElementById('dataSourceType');
            const csvUploadLabel = document.getElementById('csvUploadLabel');
            const jsonUploadLabel = document.getElementById('jsonUploadLabel');
            const apiInputLabel = document.getElementById('apiInputLabel');
            const customerApiUrl = document.getElementById('customerApiUrl');
            let lastSource = localStorage.getItem('customerDataSourceType') || 'csv';
            let lastApiUrl = localStorage.getItem('customerApiUrl') || '';
            let lastCsv = localStorage.getItem('customerCsvData') || '';
            let lastJson = localStorage.getItem('customerJsonData') || '';
            // 預設值
            dataSourceType.value = lastSource;
            if (customerApiUrl && lastApiUrl) customerApiUrl.value = lastApiUrl;
            // 切換時
            dataSourceType.addEventListener('change', function() {
                var v = this.value;
                localStorage.setItem('customerDataSourceType', v);
                csvUploadLabel.style.display = v === 'csv' ? 'block' : 'none';
                jsonUploadLabel.style.display = v === 'json' ? 'block' : 'none';
                apiInputLabel.style.display = v === 'api' ? 'block' : 'none';
                customerDatabase = [];
                showToast('請上傳/載入客戶資料');
                // 自動還原
                if (v === 'csv' && lastCsv) {
                    customerDatabase = parseCustomerCSV(lastCsv);
                    showToast('已還原上次CSV客戶資料：' + customerDatabase.length + ' 筆');
                } else if (v === 'json' && lastJson) {
                    try {
                        customerDatabase = JSON.parse(lastJson);
                        showToast('已還原上次JSON客戶資料：' + customerDatabase.length + ' 筆');
                    } catch(e) {}
                } else if (v === 'api' && lastApiUrl) {
                    customerApiUrl.value = lastApiUrl;
                }
            });
            // CSV 上傳記錄
            document.getElementById('customerCsvFile').addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = function(evt) {
                    localStorage.setItem('customerCsvData', evt.target.result);
                };
                reader.readAsText(file);
            });
            // JSON 上傳記錄
            document.getElementById('customerJsonFile').addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = function(evt) {
                    localStorage.setItem('customerJsonData', evt.target.result);
                };
                reader.readAsText(file);
            });
            // API URL 輸入記錄
            if (customerApiUrl) {
                customerApiUrl.addEventListener('input', function() {
                    localStorage.setItem('customerApiUrl', this.value.trim());
                });
            }
        })();
        // 搜尋時自動提示
        (function enhanceCustomerSearch() {
            const searchInput = document.getElementById('customerSearch');
            if (!searchInput) return;
            const origSearchCustomer = window.searchCustomer;
            window.searchCustomer = function(input) {
                if (!customerDatabase || customerDatabase.length === 0) {
                    showToast('請先上傳/載入客戶資料');
                    return;
                }
                origSearchCustomer(input);
            };
        })();

        // Customer Data Management Modal
        function openCustomerMgmtModal() {
            document.getElementById('customerDataMgmtModal').classList.add('show');
            renderCustomerMgmtTable();
        }
        function closeCustomerMgmtModal() {
            document.getElementById('customerDataMgmtModal').classList.remove('show');
        }
        document.getElementById('customerDataMgmtBtn').onclick = openCustomerMgmtModal;
        // Render table
        function renderCustomerMgmtTable() {
            const head = document.getElementById('customerMgmtTableHead');
            const body = document.getElementById('customerMgmtTableBody');
            body.innerHTML = '';
            if (!Array.isArray(customerDatabase) || customerDatabase.length === 0) {
                head.innerHTML = '<th>No Data</th>';
                return;
            }
            const keys = Object.keys(customerDatabase[0]);
            head.innerHTML = keys.map(k => `<th>${k}</th>`).join('') + '<th>Actions</th>';
            customerDatabase.forEach((row, idx) => {
                body.innerHTML += `<tr>${keys.map(k => `<td contenteditable="true" oninput="editCustomerCell(${idx},'${k}',this.innerText)">${row[k]||''}</td>`).join('')}<td><button class='btn btn-danger btn-sm' onclick='deleteCustomerRow(${idx})'>Delete</button></td></tr>`;
            });
        }
        window.editCustomerCell = function(idx, key, val) {
            customerDatabase[idx][key] = val;
        };
        window.deleteCustomerRow = function(idx) {
            if (confirm('Delete this customer?')) {
                customerDatabase.splice(idx,1);
                renderCustomerMgmtTable();
            }
        }
        // Upload CSV
        const mgmtCsv = document.getElementById('customerMgmtCsvFile');
        if (mgmtCsv) {
            mgmtCsv.onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = function(evt) {
                    customerDatabase = parseCustomerCSV(evt.target.result);
                    renderCustomerMgmtTable();
                    showToast('CSV loaded: ' + customerDatabase.length + ' rows');
                };
                reader.readAsText(file);
            };
        }
        // 只保留一段 customerMgmtJsonFile 綁定，並加 null 檢查
        const mgmtJson = document.getElementById('customerMgmtJsonFile');
        if (mgmtJson) {
            mgmtJson.onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = function(evt) {
                    try {
                        customerDatabase = JSON.parse(evt.target.result);
                        renderCustomerMgmtTable();
                        showToast('JSON loaded: ' + customerDatabase.length + ' rows');
                    } catch(err) { showToast('Invalid JSON'); }
                };
                reader.readAsText(file);
            };
        }
        // Load API
        const mgmtApiBtn = document.getElementById('customerMgmtLoadApiBtn');
        if (mgmtApiBtn) {
            mgmtApiBtn.onclick = async function() {
                const url = document.getElementById('customerMgmtApiUrl').value.trim();
                if (!url) { showToast('Enter API URL'); return; }
                try {
                    let resp = await fetch(url);
                    if (!resp.ok) throw new Error('API error');
                    customerDatabase = await resp.json();
                    renderCustomerMgmtTable();
                    showToast('API loaded: ' + customerDatabase.length + ' rows');
                } catch (err) { showToast('API load failed'); }
            };
        }
        // Export CSV
        const mgmtExportBtn = document.getElementById('customerMgmtExportCsvBtn');
        if (mgmtExportBtn) {
            mgmtExportBtn.onclick = function() {
                if (!Array.isArray(customerDatabase) || customerDatabase.length === 0) {
                    showToast('No data to export'); return;
                }
                const keys = Object.keys(customerDatabase[0]);
                let csv = keys.join(',') + '\n';
                customerDatabase.forEach(row => {
                    csv += keys.map(k => '"'+String(row[k]||'').replace(/"/g,'""')+'"').join(',') + '\n';
                });
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = 'customer_export.csv';
                link.click();
            };
        }
        // Modal 關閉 UX
        const mgmtModal = document.getElementById('customerDataMgmtModal');
        if (mgmtModal) {
            mgmtModal.addEventListener('mousedown', function(e) {
                if (e.target === mgmtModal) closeCustomerMgmtModal();
            });
        }
    </script>
    <div id="customerDataMgmtModal" class="modal">
        <div class="modal-content" style="max-width:700px;">
            <h2 class="text-lg font-semibold mb-4">Customer Data Management</h2>
            <div class="flex flex-wrap gap-4 mb-4">
                <label class="btn btn-primary mb-0">
                    Upload CSV
                    <input type="file" id="customerMgmtCsvFile" accept=".csv" hidden>
                </label>
                <label class="btn btn-primary mb-0">
                    Upload JSON
                    <input type="file" id="customerMgmtJsonFile" accept=".json,application/json" hidden>
                </label>
                <input type="text" id="customerMgmtApiUrl" class="form-input" placeholder="API Endpoint" style="width:220px;">
                <button type="button" class="btn btn-primary" id="customerMgmtLoadApiBtn">Load API</button>
                <button type="button" class="btn btn-primary" id="customerMgmtExportCsvBtn">Export CSV</button>
            </div>
            <div class="overflow-x-auto" style="max-height:300px;">
                <table class="table" id="customerMgmtTable">
                    <thead><tr id="customerMgmtTableHead"></tr></thead>
                    <tbody id="customerMgmtTableBody"></tbody>
                </table>
            </div>
            <div class="flex justify-end gap-2 mt-4">
                <button class="btn btn-danger" onclick="closeCustomerMgmtModal()">Close</button>
            </div>
        </div>
    </div>
</body>
</html>
